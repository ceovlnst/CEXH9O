<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gesti√≥n de CEXs ‚Äì CEX</title>

  <meta name="description" content="Gesti√≥n de CEXs: Calendario, lista de espera y herramientas de coordinaci√≥n ‚Äì CEX." />
  <link rel="icon" type="image/png" href="https://ceovlnst.github.io/CEXH9O/og-image.png" />
  <link rel="apple-touch-icon" href="https://ceovlnst.github.io/CEXH9O/og-image.png" />
  <meta property="og:type" content="website" />
  <meta property="og:title" content="Gesti√≥n de CEXs ‚Äì CEX" />
  <meta property="og:description" content="Calendario de CEXs, lista de espera y coordinaci√≥n." />
  <meta property="og:image" content="https://ceovlnst.github.io/CEXH9O/og-image.png" />
  <meta property="og:url" content="https://ceovlnst.github.io/programacionh9o/" />
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="Gesti√≥n de CEXs ‚Äì CEX" />
  <meta name="twitter:description" content="Calendario de CEXs, lista de espera y coordinaci√≥n." />
  <meta name="twitter:image" content="https://ceovlnst.github.io/CEXH9O/og-image.png" />

  <style>
    :root{
      --bg:#f4f7fb;
      --card:#ffffff;
      --muted:#5b6b82;
      --text:#0f172a;
      --acc:#1d4ed8;
      --line:#d7e2f0;

      --bad:#b91c1c;
      --ok:#047857;
      --warn:#b45309;

      --softAcc: rgba(29,78,216,.08);
      --softOk: rgba(4,120,87,.08);
      --softWarn: rgba(180,83,9,.08);
      --softBad: rgba(185,28,28,.08);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background:
        radial-gradient(1000px 500px at 10% -10%, rgba(29,78,216,.10), transparent 55%),
        radial-gradient(1000px 500px at 100% 0%, rgba(4,120,87,.08), transparent 55%),
        var(--bg);
      color:var(--text);
      overflow-x:hidden;
    }

    .wrap{max-width:1280px;margin:0 auto;padding:12px}
    @media(min-width: 980px){ .wrap{padding:16px} }

    .topbar{
      display:flex;gap:12px;align-items:center;justify-content:space-between;
      padding:12px 14px;border:1px solid var(--line);border-radius:16px;
      background: rgba(255,255,255,.88);
      backdrop-filter: blur(8px);
      position: sticky; top: 10px; z-index: 50;
      box-shadow: 0 8px 30px rgba(15,23,42,.06);
      flex-wrap:wrap;
      min-width:0;
    }

    .brand{display:flex;gap:12px;align-items:center;min-width:0}
    .logo{
      width:38px;
      height:38px;
      border-radius:14px;
      object-fit:contain;
      background:#fff;
      box-shadow:0 10px 25px rgba(15,23,42,.12);
      flex:0 0 auto;
    }
    .brand h1{font-size:15px;margin:0;line-height:1.2}
    .brand small{display:block;color:var(--muted);margin-top:2px}

    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;min-width:0}

    .pill{
      display:flex;gap:10px;align-items:center;flex-wrap:wrap;
      padding:8px 10px;border:1px solid var(--line);border-radius:999px;
      background: rgba(255,255,255,.92);
      color:var(--muted);
      font-size:12px;
      max-width:100%;
      min-width:0;
    }
    .pill span{color:var(--text);font-weight:700}

    .btn{
      border:1px solid var(--line);
      background: #fff;
      color:var(--text);
      padding:10px 12px;border-radius:12px;
      cursor:pointer;
      font-weight:750;
      box-shadow: 0 8px 20px rgba(15,23,42,.06);
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:6px;
    }
    .btn:hover{border-color: rgba(29,78,216,.30)}
    .btn.primary{background: var(--softAcc);border-color: rgba(29,78,216,.25);color: #0b2a78;}
    .btn.good{background: var(--softOk);border-color: rgba(4,120,87,.22);color:#064e3b;}
    .btn.bad{background: var(--softBad);border-color: rgba(185,28,28,.22);color:#7f1d1d;}
    .btn.warn{background: var(--softWarn);border-color: rgba(180,83,9,.22);color:#7c2d12;}
    .btn.ghost{background: transparent;border-color: transparent;box-shadow:none;}
    .btn.small{padding:8px 10px;border-radius:10px;font-size:12px}
    .btn:disabled{opacity:.55;cursor:not-allowed;filter:saturate(.7);box-shadow:none;}

    .grid{
      display:grid;
      grid-template-columns: minmax(0,1fr);
      gap:12px;
      margin-top:14px;
    }
    @media(min-width: 980px){
      .grid{
        grid-template-columns: 360px minmax(0,1fr);
      }
      .rightCol{
        position:sticky;
        top:12px;
        align-self:flex-start;
        display:flex;
        flex-direction:column;
        gap:12px;
        max-height:calc(100vh - 24px);
        overflow:auto;
        padding-right:4px;
      }
    }

    .card{
      border:1px solid var(--line);
      border-radius:18px;
      background: rgba(255,255,255,.92);
      backdrop-filter: blur(8px);
      padding:14px;
      box-shadow: 0 18px 45px rgba(15,23,42,.08);
      min-width:0;
    }
    .card h2{margin:0 0 10px 0;font-size:15px}
    .card h3{margin:0 0 10px 0;font-size:14px;color:var(--muted);font-weight:800}

    label{display:block;color:var(--muted);font-size:12px;margin:10px 0 6px}
    input, select, textarea{
      width:100%;
      padding:10px 12px;border-radius:12px;
      border:1px solid var(--line);
      background: #fff;
      color: var(--text);
      outline:none;
      box-shadow: 0 6px 16px rgba(15,23,42,.05);
      min-width:0;
      font-size:13px;
    }
    input:focus, select:focus, textarea:focus{
      border-color: rgba(29,78,216,.40);
      box-shadow: 0 0 0 4px rgba(29,78,216,.10);
    }
    textarea{min-height:84px;resize:vertical}

    .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .hr{height:1px;background: var(--line);margin:12px 0}

    .msg{
      margin-top:10px;
      padding:10px 12px;border-radius:12px;
      border:1px solid var(--line);
      background: #fff;
      color:var(--muted);
      font-size: 13px;
      white-space: pre-wrap;
      box-shadow: 0 10px 24px rgba(15,23,42,.06);
      min-width:0;
    }
    .msg.ok{border-color: rgba(4,120,87,.24); background: var(--softOk); color: var(--text)}
    .msg.bad{border-color: rgba(185,28,28,.22); background: var(--softBad); color: var(--text)}
    .msg.warn{border-color: rgba(180,83,9,.22); background: var(--softWarn); color: var(--text)}
    .hide{display:none !important}

    .slots{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .slot{
      padding:8px 10px;border-radius:999px;border:1px solid var(--line);
      background: #fff;
      color: var(--text);
      cursor:pointer;
      font-size: 12px;
      box-shadow: 0 10px 24px rgba(15,23,42,.06);
    }
    .slot.selected{
      border-color: rgba(29,78,216,.60);
      background: var(--softAcc);
      font-weight:700;
    }

    .structStack{
      display:flex;
      flex-direction:column;
      gap:12px;
      min-width:0;
    }
    .structPanel{
      border:1px solid var(--line);
      border-radius:16px;
      background: rgba(255,255,255,.96);
      padding:12px;
      box-shadow: 0 14px 32px rgba(15,23,42,.06);
      min-width:0;
    }
    .structPanel h3{margin:0 0 10px 0;color:var(--muted);font-size:14px;font-weight:850}

    .loadingBar{
      position: fixed;
      left: 16px;
      right: 16px;
      bottom: 16px;
      z-index: 2000;
      border: 1px solid var(--line);
      border-radius: 14px;
      background: rgba(255,255,255,.96);
      backdrop-filter: blur(8px);
      padding: 10px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      box-shadow: 0 20px 60px rgba(15,23,42,.20);
    }
    .loadingBar .txt{color: var(--text); font-size: 13px; font-weight:800}
    .loadingBar .sub{color: var(--muted); font-size: 12px}
    .loadingBar .dot{
      width:10px;height:10px;border-radius:50%;
      background: rgba(29,78,216,.9);
      box-shadow: 0 0 0 6px rgba(29,78,216,.14);
      animation: pulse 1.2s infinite ease-in-out;
    }
    @keyframes pulse{
      0%{transform:scale(.9); opacity:.6}
      50%{transform:scale(1.15); opacity:1}
      100%{transform:scale(.9); opacity:.6}
    }

    .modalBack{
      position:fixed; inset:0; background: rgba(15,23,42,.45);
      display:none; align-items:center; justify-content:center;
      padding:16px; z-index:9999;
    }
    .modal{
      width:min(520px, 94vw);
      max-height: calc(100vh - 32px);
      overflow:auto;
      border:1px solid var(--line);
      border-radius:16px;
      background:var(--card);
      box-shadow:0 18px 40px rgba(2,6,23,.18);
      padding:14px;
    }
    .modalTop{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .modalTitle{font-weight:900;font-size:16px}
    .iconBtn{border:1px solid var(--line);background:#fff;border-radius:12px;padding:6px 10px;cursor:pointer;font-weight:900;line-height:1}

    .searchFieldSmall{margin-top:4px}
    .searchFieldSmall input{
      padding:8px 10px;
      font-size:12px;
      border-radius:999px;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <img class="logo" src="https://ceovlnst.github.io/CEXH9O/og-image.png" alt="CEX" />
        <div>
          <h1>CEX</h1>
          <small id="appSubtitle">Solicitud de CEX</small>
        </div>
      </div>

      <div class="row">
        <div class="pill" id="pillSession">
          <small>Usuario</small> <span id="pillUser">‚Äî</span>
          <small>Perfil</small> <span id="pillRole">‚Äî</span>
        </div>
        <button class="btn small ghost hide" id="btnLogout">Salir</button>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT: acceso -->
      <div class="card">
        <h2>Acceso</h2>

        <label>PIN (contrase√±a)</label>
        <input id="pinInput" type="password" inputmode="numeric" placeholder="Introduce tu PIN" />

        <div class="actions">
          <button class="btn primary" id="btnLogin">Entrar</button>
          <button class="btn" id="btnClear">Limpiar</button>
        </div>

        <div id="msgLogin" class="msg hide"></div>

        <div class="hr"></div>

        <div class="actions">
          <button class="btn" id="btnToggleSignup">Darme de alta</button>
        </div>

        <div id="signupBox" class="hide">
          <h3 style="margin-top:10px">Alta profesional (solo usuarios vithas)</h3>

          <label>Nombre</label><input id="suNombre" placeholder="Nombre" />
          <label>Apellidos</label><input id="suApellidos" placeholder="Apellidos" />
          <label>Servicio / Especialidad</label><input id="suEsp" placeholder="Traumatolog√≠a, Oftalmolog√≠a‚Ä¶" />
          <label>Correo</label><input id="suCorreo" placeholder="nombre.apellido@vithas.es" />
          <label>Tel√©fono</label><input id="suTel" placeholder="Tel√©fono" />

          <div class="actions">
            <button class="btn good" id="btnSignup">Completar alta</button>
          </div>
          <div id="msgSignup" class="msg hide"></div>
        </div>

        <div class="hr"></div>

        <h2>Panel</h2>
        <div class="actions">
          <button class="btn hide" id="btnGoReserve">Solicitar CEX</button>
          <button class="btn hide" id="btnGoMine">Mis solicitudes</button>
          <button class="btn hide" id="btnGoGrid">Calendario</button>
          <button class="btn hide" id="btnGoStruct">Bloques (Master)</button>
        </div>
        <div id="msgMenu" class="msg hide"></div>
      </div>

      <!-- RIGHT: vistas -->
      <div class="rightCol">
        <!-- USER: RESERVA AUTO -->
        <div id="viewReserve" class="card hide">
          <h2>Solicitud autom√°tica de CEX</h2>
          <div class="row">
            <div style="flex:1;min-width:220px">
              <label>Fecha</label>
              <input id="rvDate" type="date" />
            </div>
            <div style="width:160px">
              <label>Duraci√≥n (h)</label>
              <select id="rvHours">
                <option>1</option><option>2</option><option>3</option><option>4</option>
                <option>5</option><option>6</option><option>7</option><option>8</option>
              </select>
            </div>
          </div>

          <div class="actions">
            <button class="btn primary" id="btnFind">Buscar hueco</button>
            <button class="btn good" id="btnConfirm">Confirmar reserva</button>
          </div>

          <div id="rvSlots" class="slots"></div>
          <div id="msgReserve" class="msg hide"></div>
        </div>

        <!-- USER: MIS RESERVAS (stub) -->
        <div id="viewMine" class="card hide">
          <h2>Mis solicitudes</h2>

          <div class="row">
            <div style="width:220px">
              <label>Horizonte (d√≠as)</label>
              <select id="mineDays">
                <option value="30">30</option>
                <option value="60">60</option>
                <option value="90">90</option>
                <option value="180">180</option>
              </select>
            </div>
            <div class="actions" style="margin-top:26px">
              <button class="btn primary" id="btnLoadMine">Actualizar</button>
            </div>
          </div>

          <div id="mineBox" class="msg hide"></div>
          <div id="msgMine" class="msg hide"></div>
        </div>

        <!-- MASTER: GRID (stub) -->
        <div id="viewGrid" class="card hide">
          <h2>Calendario quir√∫rgico</h2>
          <div class="row">
            <div style="flex:1;min-width:260px">
              <label>Fecha</label>
              <div class="row" style="gap:6px">
                <input id="gdDate" type="date" style="flex:1;min-width:0" />
                <button class="btn small" id="btnGridPrevDay" title="D√≠a anterior">‚Üê</button>
                <button class="btn small" id="btnGridNextDay" title="D√≠a siguiente">‚Üí</button>
              </div>
            </div>
          </div>
          <div id="msgGrid" class="msg hide"></div>
        </div>

        <!-- MASTER: BLOQUES (incluye CEX NO estructural con BUSCADOR) -->
        <div id="viewStruct" class="card hide">
          <h2>Bloques quir√∫rgicos (Master)</h2>

          <div class="structStack">
            <!-- NO ESTRUCTURALES -->
            <div class="structPanel">
              <h3>Crear CEX NO estructural (Master)</h3>

              <div class="row">
                <div style="flex:1;min-width:200px">
                  <label>Fecha</label>
                  <input id="stNSDate" type="date" />
                </div>
                <div style="width:160px">
                  <label>Duraci√≥n (h)</label>
                  <select id="stNSDur">
                    <option>1</option><option>2</option><option>3</option><option>4</option>
                    <option>5</option><option>6</option><option>7</option><option>8</option>
                    <option>9</option><option>10</option><option>11</option><option>12</option>
                  </select>
                </div>
              </div>

              <!-- üîç Buscador + desplegable de cirujanos (GruposQuir√∫rgicos) -->
              <div class="row">
                <div style="flex:1;min-width:220px">
                  <label>Etiqueta (cirujano)</label>

                  <div class="searchFieldSmall">
                    <input
                      id="stNSLabelSearch"
                      type="text"
                      placeholder="Buscar por cirujano, especialidad o email‚Ä¶"
                      oninput="filterStNSLabel()"
                    />
                  </div>

                  <select id="stNSLabel"></select>
                </div>
              </div>

              <div class="actions">
                <button class="btn primary" id="btnNSFindSlots">Buscar huecos</button>
                <button class="btn good" id="btnNSAssignSlot">Asignar hueco seleccionado</button>
              </div>

              <div id="stNSSlotsBox" class="slots"></div>
              <div id="msgStructNon" class="msg hide"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal gen√©rico -->
  <div id="modalBack" class="modalBack">
    <div id="modal" class="modal">
      <div class="modalTop">
        <div class="modalTitle" id="modalTitle">T√≠tulo</div>
        <button class="iconBtn" id="modalCloseBtn" type="button">‚úï</button>
      </div>
      <div id="modalBody" style="margin-top:10px"></div>
    </div>
  </div>

  <!-- Barra de carga -->
  <div id="loadingBar" class="loadingBar hide">
    <div>
      <div class="txt" id="loadingTxt">Procesando‚Ä¶</div>
      <div class="sub" id="loadingSub">Conectando con servidor‚Ä¶</div>
    </div>
    <div class="dot"></div>
  </div>

  <script>
    // ================== Estado ==================
    const S = {
      pin: null,
      doctor: null,
      isMaster: false,
      role: null,
      nsSlots: [],
      nsSelectedIdx: null,
      nsLabelOptions: [] // opciones del desplegable (base para el buscador)
    };

    function $(id){ return document.getElementById(id); }
    function show(el){ if(el) el.classList.remove("hide"); }
    function hide(el){ if(el) el.classList.add("hide"); }

    function showMsg(el, text, type){
      if(!el) return;
      el.textContent = text || "";
      el.classList.remove("hide","ok","bad","warn");
      if(type === "ok") el.classList.add("ok");
      else if(type === "bad") el.classList.add("bad");
      else if(type === "warn") el.classList.add("warn");
    }
    function hideMsg(el){
      if(!el) return;
      el.textContent = "";
      el.classList.add("hide");
      el.classList.remove("ok","bad","warn");
    }

    function todayISO(){
      const d = new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,"0");
      const dd = String(d.getDate()).padStart(2,"0");
      return y+"-"+m+"-"+dd;
    }
    function addDaysISO(days){
      const d = new Date();
      d.setDate(d.getDate()+days);
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,"0");
      const dd = String(d.getDate()).padStart(2,"0");
      return y+"-"+m+"-"+dd;
    }

    function setSessionPill(){
      const name = S.doctor ? ((S.doctor.nombre || "") + " " + (S.doctor.apellidos || "")).trim() : "‚Äî";
      const role = S.role || "‚Äî";
      $("pillUser").textContent = name || "‚Äî";
      $("pillRole").textContent = role || "‚Äî";
    }

    function isMaster(){ return !!S.isMaster; }

    function setMenuButtons(){
      const bReserve = $("btnGoReserve");
      const bMine = $("btnGoMine");
      const bGrid = $("btnGoGrid");
      const bStruct = $("btnGoStruct");
      if(S.pin){
        show(bMine);
        show(bReserve);
        if(isMaster()){
          show(bGrid);
          show(bStruct);
        }else{
          hide(bGrid);
          hide(bStruct);
        }
        show($("btnLogout"));
      }else{
        hide(bReserve); hide(bMine); hide(bGrid); hide(bStruct);
        hide($("btnLogout"));
      }
    }

    function setLoading(on, msg, sub){
      const bar = $("loadingBar");
      if(!bar) return;
      if(on){
        show(bar);
        $("loadingTxt").textContent = msg || "Procesando‚Ä¶";
        $("loadingSub").textContent = sub || "Conectando con el servidor‚Ä¶";
      }else{
        hide(bar);
      }
    }

    // Wrap de llamadas a GAS
    function callGAS(fnName, args, opts){
      opts = opts || {};
      const disable = opts.disable || [];
      const msg = opts.msg || "";
      const sub = opts.sub || "";
      const onSuccess = opts.onSuccess || function(){};
      const onFailure = opts.onFailure || function(e){ alert(e && e.message ? e.message : String(e)); };

      disable.forEach(el => el && (el.disabled = true));
      if(msg) setLoading(true, msg, sub || "Google Apps Script‚Ä¶");

      try{
        google.script.run
          .withSuccessHandler(function(res){
            setLoading(false);
            disable.forEach(el => el && (el.disabled = false));
            onSuccess(res);
          })
          .withFailureHandler(function(err){
            setLoading(false);
            disable.forEach(el => el && (el.disabled = false));
            onFailure(err);
          })[fnName].apply(null, args || []);
      }catch(e){
        setLoading(false);
        disable.forEach(el => el && (el.disabled = false));
        onFailure(e);
      }
    }

    function go(viewId){
      ["viewReserve","viewMine","viewGrid","viewStruct"].forEach(id=>{
        const el = $(id);
        if(!el) return;
        if(id === viewId) show(el); else hide(el);
      });
      hideMsg($("msgMenu"));
    }

    // ============== LOGIN / LOGOUT ====================
    function login(){
      hideMsg($("msgLogin"));
      const pin = ($("pinInput").value || "").trim();
      if(!pin){
        return showMsg($("msgLogin"), "Introduce tu PIN.", "warn");
      }

      callGAS("getDoctorByPin", [pin], {
        msg:"Validando acceso‚Ä¶",
        disable:[$("btnLogin"), $("btnClear"), $("pinInput")],
        onSuccess:function(doc){
          S.pin = pin;
          S.doctor = doc;
          const tipo = String(doc.tipo || "").trim();
          S.isMaster = /^(master|administrador|admin)$/i.test(tipo) || tipo.toLowerCase().includes("admin");
          S.role = S.isMaster ? "Administrador" : "Usuario";
          setSessionPill();
          setMenuButtons();

          if(isMaster()){
            $("gdDate").value = todayISO();
            $("stNSDate").value = todayISO();
            loadNSLabelOptions(); // cargamos cirujanos de GruposQuir√∫rgicos
            go("viewStruct");
          }else{
            $("rvDate").value = addDaysISO(1);
            $("rvHours").value = "2";
            go("viewReserve");
          }
        },
        onFailure:function(e){
          showMsg($("msgLogin"), e && e.message ? e.message : String(e), "bad");
        }
      });
    }

    function logout(){
      S.pin = null;
      S.doctor = null;
      S.isMaster = false;
      S.role = null;
      setSessionPill();
      setMenuButtons();
      go(null);
    }

    // ============== Alta usuario ======================
    function toggleSignup(){
      const box = $("signupBox");
      if(box.classList.contains("hide")) show(box); else hide(box);
    }

    function signup(){
      hideMsg($("msgSignup"));
      const payload = {
        nombre: ($("suNombre").value || "").trim(),
        apellidos: ($("suApellidos").value || "").trim(),
        especialidad: ($("suEsp").value || "").trim(),
        correo: ($("suCorreo").value || "").trim(),
        telefono: ($("suTel").value || "").trim()
      };

      callGAS("signupDoctor", [payload], {
        msg:"Registrando alta‚Ä¶",
        disable:[$("btnSignup")],
        onSuccess:function(res){
          showMsg($("msgSignup"), res && res.message ? res.message : "Alta completada.", "ok");
        },
        onFailure:function(e){
          showMsg($("msgSignup"), e && e.message ? e.message : String(e), "bad");
        }
      });
    }

    // ============== RESERVA AUTO (usuario) ============
    function userFindSlot(){
      hideMsg($("msgReserve"));
      const dateStr = $("rvDate").value;
      const hours = $("rvHours").value;
      if(!dateStr) return showMsg($("msgReserve"), "Indica la fecha.", "warn");

      callGAS("getDisponibilidadAuto", [S.pin, dateStr, hours], {
        msg:"Buscando huecos disponibles‚Ä¶",
        disable:[$("btnFind"), $("rvDate"), $("rvHours")],
        onSuccess:function(res){
          const box = $("rvSlots");
          box.innerHTML = "";
          S.nsSlots = [];
          S.nsSelectedIdx = null;

          if(!res || !res.slots || !res.slots.length){
            showMsg($("msgReserve"), "No se han encontrado huecos para ese d√≠a.", "warn");
            return;
          }

          res.slots.forEach(function(slot, idx){
            const btn = document.createElement("button");
            btn.type = "button";
            btn.className = "slot";
            btn.textContent = slot.label || (slot.orName + " ¬∑ " + (slot.start || ""));
            btn.onclick = function(){
              S.nsSelectedIdx = idx;
              Array.from(box.children).forEach((ch,i)=>{
                if(i === idx) ch.classList.add("selected");
                else ch.classList.remove("selected");
              });
            };
            box.appendChild(btn);
          });
          showMsg($("msgReserve"), "Selecciona el hueco que prefieras y pulsa Confirmar reserva.", "ok");
          S.nsSlots = res.slots;
        },
        onFailure:function(e){
          showMsg($("msgReserve"), e && e.message ? e.message : String(e), "bad");
        }
      });
    }

    function userConfirmSlot(){
      hideMsg($("msgReserve"));
      if(S.nsSelectedIdx == null){
        return showMsg($("msgReserve"), "Selecciona un hueco primero.", "warn");
      }
      const slot = S.nsSlots[S.nsSelectedIdx];
      if(!slot || !slot.orName || !slot.startISO || !slot.endISO){
        return showMsg($("msgReserve"), "Hueco inv√°lido.", "bad");
      }

      const payload = {
        orName: slot.orName,
        startISO: slot.startISO,
        endISO: slot.endISO
      };

      callGAS("bookNonStructuralFromSlot", [S.pin, payload], {
        msg:"Confirmando reserva‚Ä¶",
        disable:[$("btnConfirm")],
        onSuccess:function(res){
          showMsg($("msgReserve"), res && res.message ? res.message : "Reserva confirmada.", "ok");
        },
        onFailure:function(e){
          showMsg($("msgReserve"), e && e.message ? e.message : String(e), "bad");
        }
      });
    }

    // ============== MASTER: desplegable con BUSCADOR (GruposQuir√∫rgicos) =============
    /**
     * Carga los cirujanos desde la pesta√±a GruposQuir√∫rgicos:
     *  Cirujano | Especialidad | Email | Tel√©fono | Rol
     */
    function loadNSLabelOptions(){
      if(!isMaster() || !S.pin) return;
      const sel = $("stNSLabel");
      const inputSearch = $("stNSLabelSearch");
      if(sel) sel.innerHTML = "";
      if(inputSearch) inputSearch.value = "";

      // üëâ usamos una funci√≥n GAS nueva: listSimpleGroupsForMaster(masterPin)
      callGAS("listSimpleGroupsForMaster", [S.pin], {
        msg:"Cargando cirujanos (GruposQuir√∫rgicos)‚Ä¶",
        onSuccess:function(res){
          const items = (res && res.items) || [];
          S.nsLabelOptions = items.map(function(row){
            const cir = (row.cirujano || "").trim();
            const esp = (row.especialidad || "").trim();
            const email = (row.email || "").trim();
            const tel = (row.telefono || "").trim();
            const rol = (row.rol || "").trim();

            let label = cir;
            if(esp) label += " ¬∑ " + esp;
            if(email) label += " ¬∑ " + email;
            if(rol) label += " ¬∑ " + rol;

            return {
              value: email || cir,  // valor que usaremos como "label" en el GAS
              label: label
            };
          });

          renderStNSLabelSelect();
        },
        onFailure:function(e){
          showMsg($("msgStructNon"), e && e.message ? e.message : String(e), "bad");
        }
      });
    }

    function renderStNSLabelSelect(filteredList){
      const sel = $("stNSLabel");
      if(!sel) return;
      sel.innerHTML = "";

      const list = filteredList || S.nsLabelOptions || [];

      const optEmpty = document.createElement("option");
      optEmpty.value = "";
      optEmpty.textContent = "(elige cirujano)";
      sel.appendChild(optEmpty);

      list.forEach(function(item){
        const opt = document.createElement("option");
        opt.value = item.value || item.label;
        opt.textContent = item.label;
        sel.appendChild(opt);
      });
    }

    // üîç filtro en vivo del desplegable
    function filterStNSLabel(){
      const term = ( $("stNSLabelSearch").value || "" ).toLowerCase();
      if(!term){
        renderStNSLabelSelect();
        return;
      }
      const filtered = (S.nsLabelOptions || []).filter(function(item){
        return (item.label || "").toLowerCase().includes(term);
      });
      renderStNSLabelSelect(filtered);
    }

    // ============== MASTER: buscar / asignar CEX NO estructural =========
    function masterFindNSSlots(){
      hideMsg($("msgStructNon"));
      const dateStr = $("stNSDate").value;
      const hours = $("stNSDur").value;
      const label = $("stNSLabel").value;

      if(!dateStr) return showMsg($("msgStructNon"), "Indica la fecha.", "warn");
      if(!label) return showMsg($("msgStructNon"), "Elige etiqueta (cirujano).", "warn");

      const payload = {
        dateStr: dateStr,
        hours: hours,
        label: label
      };

      callGAS("masterFindNonStructuralSlots", [S.pin, payload], {
        msg:"Buscando huecos disponibles‚Ä¶",
        onSuccess:function(res){
          const box = $("stNSSlotsBox");
          box.innerHTML = "";
          S.nsSlots = [];
          S.nsSelectedIdx = null;

          if(!res || !res.slots || !res.slots.length){
            showMsg($("msgStructNon"), "No se han encontrado huecos para ese d√≠a.", "warn");
            return;
          }

          res.slots.forEach(function(slot, idx){
            const btn = document.createElement("button");
            btn.type = "button";
            btn.className = "slot";
            btn.textContent = slot.label || (slot.orName + " ¬∑ " + (slot.start || ""));
            btn.onclick = function(){
              S.nsSelectedIdx = idx;
              Array.from(box.children).forEach((ch,i)=>{
                if(i === idx) ch.classList.add("selected");
                else ch.classList.remove("selected");
              });
            };
            box.appendChild(btn);
          });
          showMsg($("msgStructNon"), "Selecciona un hueco y pulsa Asignar hueco seleccionado.", "ok");
          S.nsSlots = res.slots;
        },
        onFailure:function(e){
          showMsg($("msgStructNon"), e && e.message ? e.message : String(e), "bad");
        }
      });
    }

    function masterAssignNSSlot(){
      hideMsg($("msgStructNon"));
      if(S.nsSelectedIdx == null){
        return showMsg($("msgStructNon"), "Selecciona un hueco primero.", "warn");
      }
      const slot = S.nsSlots[S.nsSelectedIdx];
      if(!slot || !slot.orName || !slot.startISO || !slot.endISO){
        return showMsg($("msgStructNon"), "Hueco inv√°lido.", "bad");
      }

      const label = $("stNSLabel").value;
      if(!label){
        return showMsg($("msgStructNon"), "Elige etiqueta (cirujano).", "warn");
      }

      const payload = {
        orName: slot.orName,
        startISO: slot.startISO,
        endISO: slot.endISO,
        label: label
      };

      callGAS("masterBookNonStructuralFromSlot", [S.pin, payload], {
        msg:"Creando bloque NO estructural‚Ä¶",
        onSuccess:function(res){
          showMsg($("msgStructNon"), res && res.message ? res.message : "Bloque creado correctamente.", "ok");
        },
        onFailure:function(e){
          showMsg($("msgStructNon"), e && e.message ? e.message : String(e), "bad");
        }
      });
    }

    // ================== Modal (por si lo usas luego) =========
    function openModal(title, html){
      $("modalTitle").textContent = title || "";
      $("modalBody").innerHTML = html || "";
      show($("modalBack"));
    }
    function closeModal(){ hide($("modalBack")); }

    // ================== Wire de eventos ==================
    function wireEvents(){
      if($("btnLogin")) $("btnLogin").onclick = login;
      if($("btnClear")) $("btnClear").onclick = function(){ $("pinInput").value=""; };
      if($("btnLogout")) $("btnLogout").onclick = logout;
      if($("btnToggleSignup")) $("btnToggleSignup").onclick = toggleSignup;
      if($("btnSignup")) $("btnSignup").onclick = signup;

      if($("btnGoReserve")) $("btnGoReserve").onclick = function(){ go("viewReserve"); };
      if($("btnGoMine")) $("btnGoMine").onclick = function(){ go("viewMine"); };
      if($("btnGoGrid")) $("btnGoGrid").onclick = function(){ go("viewGrid"); };
      if($("btnGoStruct")) $("btnGoStruct").onclick = function(){ go("viewStruct"); };

      if($("btnFind")) $("btnFind").onclick = userFindSlot;
      if($("btnConfirm")) $("btnConfirm").onclick = userConfirmSlot;

      if($("btnNSFindSlots")) $("btnNSFindSlots").onclick = masterFindNSSlots;
      if($("btnNSAssignSlot")) $("btnNSAssignSlot").onclick = masterAssignNSSlot;

      if($("modalCloseBtn")) $("modalCloseBtn").onclick = closeModal;

      if($("pinInput")){
        $("pinInput").addEventListener("keydown", function(ev){
          if(ev.key === "Enter") login();
        });
      }

      if($("rvDate")) $("rvDate").value = addDaysISO(1);
      if($("stNSDate")) $("stNSDate").value = todayISO();
    }

    document.addEventListener("DOMContentLoaded", wireEvents);

    // para el oninput del HTML
    window.filterStNSLabel = filterStNSLabel;
  </script>
</body>
</html>
