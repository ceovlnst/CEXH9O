<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gesti√≥n de CEXs ‚Äì CEX</title>

  
  <!-- Iconos / previsualizaci√≥n al compartir -->
  <meta name="description" content="Gesti√≥n de CEXs: Calendario, lista de espera y herramientas de coordinaci√≥n ‚Äì CEX." />

  <link rel="icon" type="image/png" href="https://ceovlnst.github.io/CEXH9O/og-image.png" />
  <link rel="apple-touch-icon" href="https://ceovlnst.github.io/CEXH9O/og-image.png" />

  <meta property="og:type" content="website" />
  <meta property="og:title" content="Gesti√≥n de CEXs ‚Äì CEX" />
  <meta property="og:description" content="Calendario de CEXs, lista de espera y coordinaci√≥n." />
  <meta property="og:image" content="https://ceovlnst.github.io/CEXH9O/og-image.png" />
  <meta property="og:url" content="https://ceovlnst.github.io/programacionh9o/" />

  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="Gesti√≥n de CEXs ‚Äì CEX" />
  <meta name="twitter:description" content="Calendario de CEXs, lista de espera y coordinaci√≥n." />
  <meta name="twitter:image" content="https://ceovlnst.github.io/CEXH9O/og-image.png" />
<style>
    :root{
      --bg:#f4f7fb;
      --card:#ffffff;
      --muted:#5b6b82;
      --text:#0f172a;
      --acc:#1d4ed8;
      --line:#d7e2f0;

      --bad:#b91c1c;
      --ok:#047857;
      --warn:#b45309;

      --softAcc: rgba(29,78,216,0.08);
      --softOk: rgba(4,120,87,0.08);
      --softWarn: rgba(180,83,9,0.08);
      --softBad: rgba(185,28,28,0.08);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background:
        radial-gradient(1000px 500px at 10% -10%, rgba(29,78,216,0.10), transparent 55%),
        radial-gradient(1000px 500px at 100% 0%, rgba(4,120,87,0.08), transparent 55%),
        var(--bg);
      color:var(--text);
      overflow-x:hidden;
    }

    .wrap{max-width:1280px;margin:0 auto;padding:12px}
    @media(min-width: 980px){ .wrap{padding:16px} }

    .topbar{
      display:flex;gap:12px;align-items:center;justify-content:space-between;
      padding:12px 14px;border:1px solid var(--line);border-radius:16px;
      background: rgba(255,255,255,0.9);
      backdrop-filter: blur(12px);
      box-shadow:0 10px 30px rgba(15,23,42,0.06);
      margin-bottom:12px;
    }
    .topbarLeft{
      display:flex;align-items:center;gap:12px;min-width:0;
    }
    .logoBubble{
      width:40px;height:40px;border-radius:14px;
      background: radial-gradient(circle at 0 0, #1d4ed8, #16a34a);
      display:flex;align-items:center;justify-content:center;
      color:#fff;font-weight:700;font-size:20px;
      box-shadow:0 8px 20px rgba(15,23,42,0.3);
      flex-shrink:0;
    }
    .tbTexts{
      min-width:0;display:flex;flex-direction:column;gap:2px;
    }
    .tbTitle{
      font-size:16px;font-weight:600;color:#0f172a;white-space:nowrap;
      text-overflow:ellipsis;overflow:hidden;
    }
    .tbSub{
      font-size:12px;color:var(--muted);white-space:nowrap;
      text-overflow:ellipsis;overflow:hidden;
    }
    .tbBadges{
      display:flex;flex-wrap:wrap;gap:6px;
    }
    .pill{
      font-size:11px;padding:3px 8px;border-radius:999px;
      border:1px solid rgba(148,163,184,0.6);
      color:var(--muted);background:rgba(255,255,255,0.9);
      display:inline-flex;align-items:center;gap:4px;
    }
    .pill b{font-weight:600;color:#0f172a}

    .topbarRight{
      display:flex;align-items:center;gap:10px;flex-wrap:wrap;justify-content:flex-end;
    }
    .tbUser{
      display:flex;align-items:center;gap:8px;
      padding:6px 10px;border-radius:999px;
      background:rgba(15,23,42,0.03);
      border:1px dashed rgba(148,163,184,0.6);
      font-size:12px;color:var(--muted);
    }
    .tbUser span{
      display:inline-flex;align-items:center;justify-content:center;
      width:18px;height:18px;border-radius:999px;
      background:rgba(59,130,246,0.1);color:#1d4ed8;font-size:12px;font-weight:600;
    }
    .dot{
      width:6px;height:6px;border-radius:999px;
      background:#22c55e;
      box-shadow:0 0 0 5px rgba(34,197,94,0.35);
    }
    .tbEnv{
      font-size:11px;color:var(--muted);
      padding:4px 8px;border-radius:999px;
      background:rgba(15,23,42,0.03);
      border:1px solid rgba(148,163,184,0.4);
      display:flex;align-items:center;gap:6px;
    }
    .tbEnv b{font-weight:600;color:#0f172a}

    .layout{
      display:flex;gap:12px;align-items:flex-start;
    }
    @media(max-width: 900px){
      .layout{flex-direction:column;}
    }

    .leftCol{
      width:260px;flex-shrink:0;
      position:sticky;top:8px;align-self:flex-start;
    }
    @media(max-width: 900px){
      .leftCol{width:100%;position:static;}
    }

    .rightCol{
      flex:1;min-width:0;
      display:flex;flex-direction:column;gap:12px;
    }

    .card{
      background:rgba(255,255,255,0.98);
      border-radius:18px;
      border:1px solid var(--line);
      padding:14px 14px 16px;
      box-shadow:0 18px 45px rgba(15,23,42,0.06);
    }

    h2{
      margin:0 0 10px;font-size:18px;font-weight:600;
      letter-spacing:-0.01em;color:#0f172a;
    }
    h3{
      margin:0 0 8px;font-size:15px;font-weight:600;color:#0f172a;
    }

    .menuBlock{
      display:flex;flex-direction:column;gap:10px;
    }

    .field{
      display:flex;flex-direction:column;gap:4px;margin-bottom:8px;
    }
    label{
      font-size:12px;font-weight:500;color:var(--muted);
    }
    input,select,textarea{
      font-family:inherit;font-size:13px;
      border-radius:10px;border:1px solid #cbd5f5;
      padding:7px 9px;
      min-height:32px;
      outline:none;
      background:#f9fafb;
      color:var(--text);
      transition:border-color 0.12s ease, box-shadow 0.12s ease, background 0.12s ease;
    }
    input:focus,select:focus,textarea:focus{
      border-color:#2563eb;
      box-shadow:0 0 0 1px rgba(37,99,235,0.18);
      background:#ffffff;
    }

    .btn{
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.9);
      background:#ffffff;
      padding:6px 12px;
      font-size:12px;
      font-weight:500;
      color:#0f172a;
      cursor:pointer;
      display:inline-flex;align-items:center;justify-content:center;
      gap:6px;
      transition:background 0.15s ease, box-shadow 0.15s ease, transform 0.05s ease, border-color 0.15s ease;
    }
    .btn:hover{
      background:#f1f5f9;
      box-shadow:0 10px 22px rgba(15,23,42,0.08);
      transform:translateY(-0.5px);
    }
    .btn:active{
      transform:translateY(0);
      box-shadow:0 6px 14px rgba(15,23,42,0.06);
    }
    .btn.primary{
      background:linear-gradient(135deg,#2563eb,#1d4ed8);
      border-color:rgba(37,99,235,0.9);
      color:#ffffff;
      box-shadow:0 12px 30px rgba(37,99,235,0.35);
    }
    .btn.primary:hover{
      background:linear-gradient(135deg,#1d4ed8,#1e40af);
    }
    .btn.good{
      background:linear-gradient(135deg,#16a34a,#15803d);
      border-color:rgba(22,163,74,0.9);
      color:#ffffff;
      box-shadow:0 12px 30px rgba(22,163,74,0.35);
    }
    .btn.warn{
      background:linear-gradient(135deg,#ea580c,#c2410c);
      border-color:rgba(234,88,12,0.9);
      color:#ffffff;
      box-shadow:0 12px 30px rgba(234,88,12,0.35);
    }
    .btn.bad{
      background:linear-gradient(135deg,#b91c1c,#7f1d1d);
      border-color:rgba(185,28,28,0.9);
      color:#ffffff;
      box-shadow:0 12px 30px rgba(185,28,28,0.35);
    }
    .btn.small{
      padding:4px 9px;
      font-size:11px;
    }
    .btn.tiny{
      padding:3px 7px;
      font-size:10px;
    }
    .btn[disabled], .btn.disabled{
      opacity:0.55;cursor:default;
      box-shadow:none;
      transform:none;
    }

    .navBtn{
      width:100%;
      justify-content:flex-start;
      padding:7px 10px;
      border-radius:12px;
      border-color:transparent;
      background:transparent;
    }
    .navBtn span{
      flex:1;text-align:left;
    }
    .navBtn b{
      font-weight:600;
    }
    .navBtn .badge{
      font-size:10px;
      padding:2px 6px;
      border-radius:999px;
      background:rgba(148,163,184,0.18);
      color:#475569;
    }
    .navBtn.active{
      background:linear-gradient(135deg,rgba(37,99,235,0.1),rgba(37,99,235,0.03));
      border-color:rgba(37,99,235,0.8);
      box-shadow:0 12px 28px rgba(37,99,235,0.25);
    }

    .sectionTitle{
      font-size:11px;font-weight:600;
      text-transform:uppercase;
      letter-spacing:0.08em;
      color:#64748b;
      margin:10px 2px 4px;
    }

    .row{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:flex-end;
      margin-bottom:8px;
    }

    .actions{
      display:flex;flex-wrap:wrap;gap:8px;align-items:center;
      margin-top:6px;
    }

    .msg{
      border-radius:12px;
      padding:8px 10px;
      font-size:12px;
      margin-top:8px;
      border:1px solid transparent;
      display:flex;align-items:flex-start;gap:6px;
    }
    .msg.ok{
      background:var(--softOk);
      border-color:#16a34a;
      color:#166534;
    }
    .msg.bad{
      background:var(--softBad);
      border-color:#b91c1c;
      color:#7f1d1d;
    }
    .msg.warn{
      background:var(--softWarn);
      border-color:#b45309;
      color:#92400e;
    }
    .msg.info{
      background:var(--softAcc);
      border-color:#1d4ed8;
      color:#1e3a8a;
    }
    .msg.hide{display:none;}

    .hint{
      font-size:11px;
      color:#64748b;
      margin-top:4px;
    }

    .tableWrap{
      width:100%;
      overflow:auto;
      border-radius:14px;
      border:1px solid var(--line);
      background:#ffffff;
    }

    table{
      width:100%;
      border-collapse:collapse;
      font-size:12px;
    }
    th,td{
      padding:6px 8px;
      border-bottom:1px solid #e2e8f0;
      white-space:nowrap;
    }
    th{
      text-align:left;
      font-weight:600;
      background:#f8fafc;
      color:#475569;
      position:sticky;
      top:0;
      z-index:1;
    }
    tr:nth-child(even) td{
      background:#f9fafb;
    }

    .slots{
      margin-top:8px;
      border-radius:12px;
      border:1px dashed #cbd5f5;
      padding:6px;
      display:flex;
      flex-direction:column;
      gap:6px;
      background:#f8fafc;
      max-height:260px;
      overflow:auto;
    }
    .slotsItem{
      display:flex;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
      gap:6px;
      padding:6px 8px;
      border-radius:10px;
      border:1px solid #e2e8f0;
      background:#ffffff;
      cursor:pointer;
      transition:background 0.1s ease, box-shadow 0.12s ease, transform 0.03s ease, border-color 0.1s ease;
    }
    .slotsItem:hover{
      background:#f1f5f9;
      box-shadow:0 8px 18px rgba(15,23,42,0.12);
      transform:translateY(-0.5px);
    }
    .slotsItem.selected{
      border-color:#2563eb;
      box-shadow:0 10px 24px rgba(37,99,235,0.3);
      background:linear-gradient(135deg,rgba(37,99,235,0.12),rgba(255,255,255,0.95));
    }
    .slotsMain{
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .slotsTitle{
      font-size:12px;font-weight:600;color:#0f172a;
    }
    .slotsMeta{
      font-size:11px;color:#64748b;
    }

    .structStack{
      display:flex;
      flex-direction:column;
      gap:12px;
      margin-top:6px;
    }
    .structPanel{
      border-radius:14px;
      border:1px solid var(--line);
      padding:10px 10px 10px;
      background:#f9fafb;
    }
    .structPanel:nth-child(odd){
      background:#ffffff;
    }

    .hr{
      margin:10px -10px 10px;
      border-top:1px dashed #d1d5db;
    }

    .weekPick{
      display:flex;flex-wrap:wrap;gap:6px;
    }
    .wchip{
      display:inline-flex;align-items:center;gap:5px;
      padding:4px 8px;border-radius:999px;
      background:#f1f5f9;
      border:1px solid #d1d5db;
      font-size:11px;color:#475569;
      cursor:pointer;
    }
    .wchip input{margin:0;}
    .wchip b{font-weight:600;}

    .kpi{
      display:flex;flex-wrap:wrap;gap:10px;
      margin-top:8px;
    }
    .kpiItem{
      min-width:0;
      flex:1;
      padding:6px 9px;
      border-radius:12px;
      background:#f1f5f9;
      border:1px solid #e2e8f0;
      display:flex;flex-direction:column;gap:2px;
      font-size:11px;
    }
    .kpiItem b{font-size:13px;}

    .reportGrid{
      width:100%;
      overflow:auto;
      max-height:360px;
      border-radius:14px;
      border:1px solid var(--line);
      background:#ffffff;
      margin-top:8px;
    }
    .reportGrid.hide{display:none;}

    .filterBar{
      display:flex;flex-wrap:wrap;gap:10px;align-items:flex-end;
      margin-top:6px;margin-bottom:6px;
    }

    .tagList{
      display:flex;flex-wrap:wrap;gap:6px;
      margin-top:4px;
    }
    .tag{
      font-size:11px;padding:3px 7px;border-radius:999px;
      background:#f3f4f6;
      border:1px solid #e5e7eb;
      color:#4b5563;
    }

    .rhead{
      display:flex;align-items:center;justify-content:space-between;
      gap:8px;
      margin-top:10px;
    }

    .modalOverlay{
      position:fixed;inset:0;
      display:none;
      align-items:center;justify-content:center;
      background:rgba(15,23,42,0.35);
      z-index:9999;
      padding:12px;
    }
    .modal{
      max-width:420px;width:100%;
      background:#ffffff;
      border-radius:18px;
      border:1px solid var(--line);
      box-shadow:0 18px 45px rgba(15,23,42,0.35);
      padding:14px 14px 14px;
      display:flex;flex-direction:column;gap:10px;
    }
    .modalHeader{
      display:flex;align-items:center;justify-content:space-between;gap:8px;
    }
    .modalTitle{
      font-size:15px;font-weight:600;color:#0f172a;
    }
    .modalBody{font-size:13px;color:#111827;}
    .modalFooter{
      display:flex;justify-content:flex-end;gap:8px;
    }

    .subtle{
      font-size:11px;color:#6b7280;
    }

    .badgeDot{
      width:8px;height:8px;border-radius:999px;
      background:#f97316;
    }

    .menuGroup{
      padding:10px 10px;
      border-radius:14px;
      background:rgba(248,250,252,0.9);
      border:1px dashed rgba(148,163,184,0.6);
      display:flex;flex-direction:column;gap:5px;
      margin-bottom:12px;
    }

    .loadingBar{
      position:fixed;
      left:50%;top:10px;
      transform:translateX(-50%);
      min-width:260px;
      max-width:90vw;
      z-index:9999;
      background:#0f172a;
      color:#e5e7eb;
      border-radius:999px;
      padding:7px 12px;
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      box-shadow:0 18px 45px rgba(15,23,42,0.45);
      font-size:12px;
    }
    .loadingBar.hide{display:none;}
    .loadingMain{
      display:flex;flex-direction:column;gap:2px;
    }
    .loadingTitle{font-weight:600;}
    .loadingSub{font-size:11px;color:#cbd5f5;}
    .loadingDot{
      width:20px;height:20px;border-radius:999px;
      border:2px solid rgba(148,163,184,0.6);
      border-top-color:#38bdf8;
      animation:spin 0.8s linear infinite;
    }
    @keyframes spin{
      from{transform:rotate(0deg);}
      to{transform:rotate(360deg);}
    }

    .msgLogin{
      margin-top:8px;
    }

    .gridLegend{
      display:flex;flex-wrap:wrap;gap:8px;
      font-size:11px;color:#6b7280;margin-top:6px;
    }
    .glegItem{display:flex;align-items:center;gap:4px;}
    .glegSwatch{
      width:10px;height:10px;border-radius:3px;
      border:1px solid rgba(148,163,184,0.8);
    }

    .pillMini{
      font-size:10px;
      padding:2px 6px;
      border-radius:999px;
      background:rgba(15,23,42,0.03);
      border:1px solid rgba(148,163,184,0.7);
      color:#475569;
    }

    textarea{
      resize:vertical;
      min-height:60px;
    }

    .grpHeader{
      display:flex;align-items:flex-start;justify-content:space-between;gap:10px;margin-bottom:6px;
    }

    .grpList{
      margin-top:8px;
      border-radius:14px;
      border:1px solid var(--line);
      background:#ffffff;
      max-height:350px;
      overflow:auto;
    }
    .grpRow{
      display:flex;flex-wrap:wrap;align-items:center;gap:8px;
      padding:7px 10px;
      border-bottom:1px solid #e5e7eb;
      font-size:12px;
    }
    .grpRow:nth-child(even){
      background:#f9fafb;
    }
    .grpName{
      font-weight:600;color:#0f172a;min-width:120px;
    }
    .grpSpec{
      font-size:11px;color:#64748b;
    }
    .grpMeta{
      display:flex;flex-wrap:wrap;gap:6px;
      font-size:11px;color:#4b5563;
    }

    .dlgGrid{
      display:grid;
      grid-template-columns:auto 1fr;
      gap:4px 8px;
      font-size:12px;
    }
    .dlgK{
      font-weight:600;color:#4b5563;
    }
    .dlgV{
      color:#111827;
    }

    .pillTiny{
      font-size:10px;
      padding:2px 6px;
      border-radius:999px;
      background:rgba(15,23,42,0.04);
      border:1px solid rgba(148,163,184,0.8);
      color:#475569;
    }
  </style>
</head>
<body>

<div id="loadingBar" class="loadingBar hide">
  <div class="loadingMain">
    <div id="loadingTitle" class="loadingTitle">Procesando‚Ä¶</div>
    <div id="loadingSub" class="loadingSub">Por favor, espera</div>
  </div>
  <div class="loadingDot"></div>
</div>

<div class="wrap">
  <header class="topbar">
    <div class="topbarLeft">
      <div class="logoBubble">C</div>
      <div class="tbTexts">
        <div class="tbTitle">Gesti√≥n de CEXs</div>
        <div class="tbSub">Calendario, reservas no estructurales, parrilla y lista de espera.</div>
        <div class="tbBadges">
          <span class="pill"><span class="badgeDot"></span><span>Entorno <b>hospitalario</b></span></span>
          <span class="pill">Panel CEX ¬∑ <b>H9O</b></span>
        </div>
      </div>
    </div>
    <div class="topbarRight">
      <div class="tbEnv">
        <span class="dot"></span>
        <span>Conectado a <b>Apps Script</b> v√≠a Worker</span>
      </div>
      <div class="tbUser">
        <span id="loginInitial">?</span>
        <div style="display:flex;flex-direction:column;gap:2px;">
          <div id="loginName" style="font-size:12px;font-weight:500;">Sin sesi√≥n</div>
          <div style="font-size:11px;color:#9ca3af;">Introduce tu clave personal para continuar</div>
        </div>
      </div>
    </div>
  </header>

  <main class="layout">
    <!-- LEFT MENU -->
    <aside class="leftCol">
      <div class="card">
        <div class="sectionTitle">Acceso</div>
        <div class="menuGroup">
          <div class="field">
            <label>Pin personal (4‚Äì6 d√≠gitos)</label>
            <input id="pin" type="password" inputmode="numeric" autocomplete="off" />
          </div>
          <div class="actions">
            <button class="btn primary" id="btnLogin">Entrar</button>
            <button class="btn tiny" id="btnLogout">Salir</button>
          </div>
          <div id="msgLogin" class="msg msgLogin hide"></div>
        </div>

        <div class="sectionTitle">Navegaci√≥n</div>
        <div class="menuGroup">
          <button class="btn navBtn" id="btnGoReserve">
            <span><b>Solicitud de CEX</b></span>
          </button>
          <button class="btn navBtn" id="btnGoMine">
            <span><b>Mis CEXs</b></span>
          </button>
        </div>

        <div class="sectionTitle">Master</div>
        <div class="menuGroup">
          <button class="btn navBtn" id="btnGoGrid">
            <span><b>Calendario CEX</b></span>
            <span class="badge">Master</span>
          </button>
          <button class="btn navBtn" id="btnGoStruct">
            <span><b>Generar CEXs</b></span>
            <span class="badge">Master</span>
          </button>
          <button class="btn navBtn" id="btnGoWait">
            <span><b>Lista de espera</b></span>
            <span class="badge">Master</span>
          </button>
          <button class="btn navBtn" id="btnGoReport">
            <span><b>Reporte</b></span>
            <span class="badge">Direcci√≥n</span>
          </button>
          <button class="btn navBtn" id="btnGoGroups">
            <span><b>Equipos m√©dicos</b></span>
          </button>
          <button class="btn navBtn" id="btnGoAddGroup">
            <span><b>A√±adir grupo</b></span>
          </button>
        </div>

        <div id="msgMenu" class="msg hide"></div>
      </div>
    </aside>

    <!-- RIGHT -->
    <section class="rightCol">
      <div class="card">
        <!-- USER: RESERVAR -->
        <div id="viewReserve" class="hide">
          <h2>Solicitud de CEX</h2>
          <div class="row">
            <div style="flex:1;min-width:260px">
              <label>Fecha</label>
              <div class="row" style="gap:6px">
                <input id="rvDate" type="date" style="flex:1;min-width:0" />
                <button class="btn small" id="btnRvPrevDay" title="D√≠a anterior">‚Üê</button>
                <button class="btn small" id="btnRvNextDay" title="D√≠a siguiente">‚Üí</button>
              </div>
            </div>
            <div style="width:160px">
              <label>Duraci√≥n (h)</label>
              <select id="rvHours">
                <option>1</option><option>2</option><option>3</option><option>4</option>
                <option>5</option><option>6</option><option>7</option><option>8</option>
              </select>
            </div>
          </div>

          <div class="actions">
            <button class="btn primary" id="btnCheckSlots">Ver disponibilidad</button>
            <button class="btn warn hide" id="btnOpenWaitlistFromReserve">Solicitar lista de espera</button>
          </div>

          <div id="slotsBox" class="slots"></div>
          <div id="msgReserve" class="msg hide"></div>
        </div>

        <!-- USER: M√çOS -->
        <div id="viewMine" class="hide">
          <h2>Mis CEXs</h2>
          <div class="row">
            <div style="flex:1;min-width:260px">
              <label>Rango</label>
              <div class="row" style="gap:6px">
                <input id="mineStart" type="date" style="flex:1;min-width:0" />
                <input id="mineEnd" type="date" style="flex:1;min-width:0" />
              </div>
            </div>
            <div class="actions" style="margin-top:26px">
              <button class="btn primary" id="btnLoadMine">Actualizar</button>
            </div>
          </div>
          <div id="mineList" class="tableWrap"></div>
          <div id="msgMine" class="msg hide"></div>
        </div>

        <!-- MASTER: GRID -->
        <div id="viewGrid" class="hide">
          <h2>Calendario quir√∫rgica</h2>
          <div class="row">
            <div style="flex:1;min-width:260px">
              <label>Fecha</label>
              <div class="row" style="gap:6px">
                <input id="gdDate" type="date" style="flex:1;min-width:0" />
                <button class="btn small" id="btnGridPrevDay" title="D√≠a anterior">‚Üê</button>
                <button class="btn small" id="btnGridNextDay" title="D√≠a siguiente">‚Üí</button>
              </div>
            </div>
            <div style="width:160px; display:none">
              <label>Duraci√≥n (h) reserva</label>
              <select id="gdHours">
                <option>1</option><option>2</option><option>3</option><option>4</option>
                <option>5</option><option>6</option><option>7</option><option>8</option>
              </select>
            </div>
            <div class="actions" style="margin-top:26px">
              <button class="btn primary" id="btnLoadGrid">Cargar Calendario</button>
            </div>
          </div>

          <div id="gridReserveInfo" class="msg hide" style="margin-top:8px"></div>
          <div class="kpi" id="gridKpis"></div>

          <div class="actions" style="margin-top:8px">
            <button class="btn small" id="btnToggleAdvanced">B√∫squeda avanzada</button>
          </div>
          <div id="advancedBox" class="hide" style="margin-top:4px">
            <label>CEXs incluidos en KPIs</label>
            <div id="orCalcChips" class="weekPick"></div>
          </div>

          <div id="gridBox" class="tableWrap" style="margin-top:10px"></div>
          <div id="msgGrid" class="msg hide"></div>
        </div>

        <!-- MASTER: ESTRUCTURALES + NO ESTRUCTURALES -->
        <div id="viewStruct" class="hide">
          <h2>Generar CEXs</h2>

          <div class="structStack">
            <!-- NO ESTRUCTURALES (ARRIBA) -->
            <div class="structPanel">
              <h3>Crear CEX NO estructural (Master)</h3>

              <div class="row">
                <div style="flex:1;min-width:200px">
                  <label>Fecha</label>
                  <input id="stNSDate" type="date" />
                </div>
                <div style="width:160px">
                  <label>Duraci√≥n (h)</label>
                  <select id="stNSDur">
                    <option>1</option><option>2</option><option>3</option><option>4</option>
                    <option>5</option><option>6</option><option>7</option><option>8</option>
                    <option>9</option><option>10</option><option>11</option><option>12</option>
                  </select>
                </div>
              </div>

              <div class="row">
                <div style="flex:1;min-width:220px">
                  <label>B√∫squeda de profesional (nombre / email)</label>
                  <input id="stNSDoctorSearch" placeholder="Empieza a escribir para filtrar‚Ä¶" />
                </div>
              </div>

              <div class="row">
                <div style="flex:1;min-width:220px">
                  <label>Profesional</label>
                  <select id="stNSDoctorSelect"></select>
                </div>
                <div style="flex:1;min-width:220px">
                  <label>Email</label>
                  <input id="stNSDoctorEmail" placeholder="Se rellena al elegir profesional (editable)" />
                </div>
              </div>

              <div class="row">
                <div style="flex:1;min-width:220px">
                  <label>Etiqueta (grupo / m√©dico)</label>
                  <input id="stNSLabel" placeholder="Etiqueta visible en calendario (grupo / m√©dico)" />
                </div>
              </div>

              <div class="actions">
                <button class="btn primary" id="btnNSFindSlots">Buscar huecos</button>
                <button class="btn good" id="btnNSAssignSlot">Asignar hueco seleccionado</button>
              </div>

              <div id="stNSSlotsBox" class="slots"></div>
              <div id="msgStructNon" class="msg hide"></div>
            </div>

            <!-- EDITOR ESTRUCTURAL -->
            <div class="structPanel">
              <div class="actions" style="margin-top:0">
                <button class="btn" id="btnNewStruct">Nuevo</button>
                <button class="btn good" id="btnSaveStruct">Guardar</button>
                <button class="btn bad" id="btnDeleteStructById">Eliminar por ID</button>
                <button class="btn primary" id="btnReloadStruct">Actualizar listado</button>
              </div>

              <div id="msgStructEdit" class="msg hide"></div>

              <div class="hr"></div>
              <h3>Editor de programaci√≥n estructural</h3>

              <div class="row">
                <div style="flex:1;min-width:240px">
                  <label>ID (vac√≠o = nuevo)</label>
                  <input id="stId" placeholder="(vac√≠o para crear)" />
                </div>
                <div style="flex:1;min-width:240px">
                  <label>Equipo / Servicio (etiqueta)</label>
                  <select id="stLabel"></select>
                </div>
              </div>

              <div class="row">
                <div style="flex:1;min-width:240px">
                  <label>CEX</label>
                  <select id="stOr"></select>
                </div>
                <div style="width:160px">
                  <label>Hora inicio</label>
                  <select id="stStartHour"></select>
                </div>
                <div style="width:160px">
                  <label>Duraci√≥n (h)</label>
                  <select id="stHours">
                    <option>1</option><option>2</option><option>3</option><option>4</option>
                    <option>5</option><option>6</option><option>7</option><option>8</option>
                  </select>
                </div>
              </div>

              <div class="row">
                <div style="flex:1;min-width:240px">
                  <label>Cadencia</label>
                  <select id="stCadence">
                    <option value="WEEKLY">Semanales</option>
                    <option value="MONTH_WEEKS">Semanas del mes</option>
                    <option value="CUSTOM">Cadencia personalizada</option>
                  </select>
                </div>
                <div style="flex:1;min-width:240px">
                  <label>Desde</label>
                  <input id="stFrom" type="date" />
                </div>
                <div style="flex:1;min-width:240px">
                  <label>Hasta</label>
                  <input id="stTo" type="date" />
                </div>
              </div>

              <div class="row">
                <div style="flex:1;min-width:240px">
                  <label>D√≠as de la semana</label>
                  <div class="weekPick">
                    <label class="wchip"><input type="checkbox" class="stDow" value="1"><b>L</b></label>
                    <label class="wchip"><input type="checkbox" class="stDow" value="2"><b>M</b></label>
                    <label class="wchip"><input type="checkbox" class="stDow" value="3"><b>X</b></label>
                    <label class="wchip"><input type="checkbox" class="stDow" value="4"><b>J</b></label>
                    <label class="wchip"><input type="checkbox" class="stDow" value="5"><b>V</b></label>
                    <label class="wchip"><input type="checkbox" class="stDow" value="6"><b>S</b></label>
                    <label class="wchip"><input type="checkbox" class="stDow" value="0"><b>D</b></label>
                  </div>
                </div>
                <div style="flex:1;min-width:240px" id="boxMonthWeeks" class="hide">
                  <label>Semanas del mes</label>
                  <div class="weekPick">
                    <label class="wchip"><input type="checkbox" class="stWom" value="1"><b>1</b>¬™</label>
                    <label class="wchip"><input type="checkbox" class="stWom" value="2"><b>2</b>¬™</label>
                    <label class="wchip"><input type="checkbox" class="stWom" value="3"><b>3</b>¬™</label>
                    <label class="wchip"><input type="checkbox" class="stWom" value="4"><b>4</b>¬™</label>
                    <label class="wchip"><input type="checkbox" class="stWom" value="5"><b>5</b>¬™</label>
                  </div>
                  <div class="hint">Interpretaci√≥n por ‚Äú1¬∫/3¬∫ lunes‚Äù, etc. seg√∫n el/los weekday seleccionados.</div>
                </div>
              </div>
            </div>

            <!-- LISTA ESTRUCTURAL -->
            <div class="structPanel">
              <h3>Listado de programaci√≥n estructural</h3>

              <div id="structSummary" class="msg" style="margin-top:8px"></div>

              <div class="hr"></div>

              <div class="filterBar">
                <div class="field">
                  <label>Filtrar por equipo (etiqueta)</label>
                  <select id="structTeamFilter">
                    <option value="">(Todos)</option>
                  </select>
                </div>

                <div class="field">
                  <label>Filtrar por CEX</label>
                  <select id="structOrFilter">
                    <option value="">(Todos)</option>
                  </select>
                </div>
                <div class="field">
                  <label>Filtrar por hora de inicio</label>
                  <select id="structHourFilter">
                    <option value="">(Todas)</option>
                  </select>
                </div>
              </div>

              <div id="structList" class="tableWrap"></div>
            </div>
          </div>
        </div>

        <!-- MASTER: WAITLIST -->
        <div id="viewWait" class="hide">
          <h2>Lista de espera</h2>
          <div class="row">
            <div style="flex:1;min-width:240px">
              <label>Filtro</label>
              <select id="wlFilter">
                <option value="all">Todas las peticiones</option>
                <option value="pending">Pendientes (sin pasadas)</option>
                <option value="pendingAll">Pendientes (incluye pasadas)</option>
              </select>
            </div>
            <div class="actions" style="margin-top:26px">
              <button class="btn primary" id="btnLoadWait">Actualizar</button>
            </div>
          </div>

          <div id="msgWait" class="msg hide"></div>
          <div id="waitList" style="margin-top:10px"></div>
        </div>

        <!-- MASTER: REPORT -->
        <div id="viewReport" class="hide">
          <h2>Reporte</h2>
          <div class="row">
            <div style="flex:1;min-width:260px">
              <label>Email destino</label>
              <input id="rpEmail" placeholder="destino@." />
            </div>
          </div>
          <div class="row">
            <div style="flex:1;min-width:220px">
              <label>Inicio</label>
              <input id="rpStart" type="date" />
            </div>
            <div style="flex:1;min-width:220px">
              <label>Fin</label>
              <input id="rpEnd" type="date" />
            </div>
          </div>
          <div class="actions">
            <button class="btn primary" id="btnSendReport">Enviar reporte (Direcci√≥n)</button>
          </div>
          <div class="hint">Incluye visi√≥n global y desglosa <b>Programado</b>, <b>Especiales (H√≠brido)</b> y <b>Urgencias/24h</b>. M√©trica: <b>horas reales</b> (no n√∫mero de eventos).</div>
          <div id="msgReport" class="msg hide"></div>

          <div class="hr"></div>

          <div class="rhead">
            <h3 style="margin:0">Reporte estructural (visual)</h3>
            <div class="actions" style="margin-top:0">
              <button class="btn small primary" id="btnStructVisualReport">Generar / actualizar</button>
            </div>
          </div>
          <div class="hint">Distribuci√≥n de CEXs estructurales por <b>d√≠a</b>, <b>CEX</b> y <b>sesi√≥n</b> (ma√±ana/tarde).</div>
          <div id="structVisualReport" class="reportGrid hide"></div>
        </div>

        <!-- MASTER: EQUIPOS m√©dicos -->
        <div id="viewGroups" class="hide">
          <div class="row" style="justify-content:space-between;align-items:flex-end;gap:12px;">
            <div style="flex:1;min-width:220px">
              <h2 style="margin-bottom:4px;">Equipos m√©dicos</h2>
              <div class="hint">Listado de grupos / equipos para etiquetar la programaci√≥n estructural. Proceden de la hoja <b>GruposQuir√∫rgicos</b>.</div>
            </div>
            <div class="actions">
              <button class="btn small" id="btnGroupsReload">Actualizar</button>
              <button class="btn small primary" id="btnGroupsAdd">Nuevo grupo</button>
            </div>
          </div>

          <div id="msgGroups" class="msg hide"></div>

          <div class="grpHeader">
            <div class="field" style="flex:2;min-width:220px">
              <label>Buscar</label>
              <input id="groupsSearch" placeholder="Nombre, especialidad, email..." />
            </div>
            <div class="field" style="flex:1;min-width:180px">
              <label>Especialidad</label>
              <select id="groupsSpecFilter">
                <option value="">(Todas)</option>
              </select>
            </div>
          </div>

          <div id="groupsList" class="grpList"></div>
        </div>
      </div>
    </section>
  </main>
</div>

<!-- MODAL cambio de equipo -->
<div id="swapModalOverlay" class="modalOverlay">
  <div class="modal">
    <div class="modalHeader">
      <div class="modalTitle">Solicitar cambio de equipo</div>
      <button class="btn tiny" id="btnModalClose">Cerrar</button>
    </div>
    <div class="modalBody">
      <div id="swapModalContent"></div>
      <div class="hint" style="margin-top:8px">Se enviar√° un correo al equipo actual y al nuevo equipo propuesto, con copia a coordinaci√≥n, para que puedan validar el cambio.</div>
      <div class="field" style="margin-top:8px">
        <label>Comentario adicional (opcional)</label>
        <textarea id="swapComment" placeholder="Motivo del cambio, informaci√≥n relevante..."></textarea>
      </div>
      <div class="subtle" style="margin-top:4px;">Si se ha pactado entre equipos, ind√≠calo para agilizar la aprobaci√≥n.</div>
    </div>
    <div class="modalFooter">
      <div id="swapStatus" class="subtle" style="flex:1;text-align:left;"></div>
      <button class="btn tiny" id="btnModalApply">Enviar solicitud</button>
    </div>
  </div>
</div>

<script>
  "use strict";

  function $(id){return document.getElementById(id);}

  const S = {
    pin:"",
    sessionKey:"",
    role:"user",
    orList:[],
    doctorList:[],
    doctorListLoaded:false,
    structData:[],
    structVisual:null,
    groups:[],
    groupsFilter:"",
    groupsSpec:"",
    orCalcSelected:[],
    masterNSSlots:[],
    masterNSSelectedIndex:-1,
    masterNSQuery:null,
  };

  const OR_LIST = [
    "CEX1","CEX2","CEX3","CEX4","CEX5","CEX6","CEX7","CEX8",
    "CEX9","CEX10","CEX11","CEX12","CEX13","CEX14",
    "CEX H√≠brido","Urgencias","Paritorio 1","Paritorio 2","S√≥tano 6"
  ];

  let sessionToken = String(Math.random()).slice(2) + String(Date.now());
  let busyCount = 0;
  let disabledEls = new Set();
  let inFlightKeys = new Set();

  function escapeHtml(s){
    return String(s == null ? "" : s)
      .replace(/&/g,"&amp;")
      .replace(/</g,"&lt;")
      .replace(/>/g,"&gt;")
      .replace(/"/g,"&quot;")
      .replace(/'/g,"&#39;");
  }

  function showMsg(el, text, type){
    if(!el) return;
    el.classList.remove("hide","ok","bad","warn","info");
    if(type) el.classList.add(type);
    el.innerHTML = escapeHtml(text || "");
  }
  function hideMsg(el){
    if(!el) return;
    el.classList.add("hide");
    el.innerHTML = "";
  }

  function setBusy(isBusy, msg){
    const bar = $("loadingBar");
    if(!bar) return;
    const txt = $("loadingTitle");
    const sub = $("loadingSub");
    if(isBusy){
      busyCount++;
      txt.textContent = msg || "Procesando‚Ä¶";
      sub.textContent = "Por favor, espera";
      bar.classList.remove("hide");
    }else{
      busyCount = Math.max(0, busyCount - 1);
      if(busyCount === 0){
        bar.classList.add("hide");
        txt.textContent = "Procesando‚Ä¶";
        sub.textContent = "Por favor, espera";
      }
    }
  }

  function disableEls(els, disabled){
    const arr = Array.isArray(els) ? els : [els];
    arr.filter(Boolean).forEach(el=>{
      if(disabled){
        el.disabled = true;
        disabledEls.add(el);
      }else{
        el.disabled = false;
        disabledEls.delete(el);
      }
    });
  }

  function resetAllBusyUI(){
    busyCount = 0;
    inFlightKeys.clear();
    $("loadingBar").classList.add("hide");
    for(const el of Array.from(disabledEls)){
      try{ el.disabled = false; }catch(_){}
    }
    disabledEls.clear();
  }

  // üîß URL del Worker (Cloudflare) que hace proxy al WebApp de Apps Script (para GitHub Pages)
  const API_WORKER_URL = "https://cexh9o.ceo-vlnst.workers.dev";

  function callGAS(fnName, args, opt){
    const o = opt || {};
    const key = o.key ? String(o.key) : "";
    if(key && inFlightKeys.has(key)) return;
    if(key) inFlightKeys.add(key);

    const myToken = sessionToken;
    setBusy(true, o.msg || "Procesando‚Ä¶");
    disableEls(o.disable || [], true);

    const finalize = ()=>{
      if(key) inFlightKeys.delete(key);
      disableEls(o.disable || [], false);
      setBusy(false);
    };

    (async ()=>{
      try{
        if(!API_WORKER_URL){
          throw new Error("API_WORKER_URL no configurada en el index (URL del Worker).");
        }

        const resp = await fetch(API_WORKER_URL, {
          method: "POST",
          headers: { "Content-Type":"text/plain;charset=utf-8" },
          body: JSON.stringify({ fn: fnName, args: args || [] })
        });

        const txt = await resp.text();
        let json;
        try{ json = JSON.parse(txt); }catch(_e){ throw new Error("Respuesta no-JSON del backend: " + txt.slice(0,200)); }

        if(!json || json.ok !== true){
          throw new Error((json && json.error) ? json.error : "Error desconocido");
        }

        if(myToken !== sessionToken) { finalize(); return; }
        try{ o.onSuccess && o.onSuccess(json.data); } finally { finalize(); }

      }catch(err){
        if(myToken !== sessionToken) { finalize(); return; }
        console.error("API error", err);
        try{ o.onFailure && o.onFailure(err); } finally { finalize(); }
      }
    })();
  }

  // ===== OR filter para KPIs Calendario =====
  function initOrCalcDefaults(){
    const exclude = new Set(["S√≥tano 6","CEX H√≠brido","Urgencias","Paritorio 1","Paritorio 2"]);
    S.orCalcSelected = OR_LIST.filter(name => !exclude.has(name));
  }

  function buildOrCalcChips(){
    const box = $("orCalcChips");
    if(!box) return;
    box.innerHTML = "";
    const selected = new Set(S.orCalcSelected || []);
    OR_LIST.forEach(name=>{
      const lbl = document.createElement("label");
      lbl.className = "wchip";
      const cb = document.createElement("input");
      cb.type = "checkbox";
      cb.checked = selected.has(name);
      cb.onchange = ()=>{
        const set = new Set(S.orCalcSelected || []);
        if(cb.checked) set.add(name); else set.delete(name);
        S.orCalcSelected = Array.from(set);
        renderGridKpis();
      };
      const b = document.createElement("b");
      b.textContent = name;
      lbl.appendChild(cb);
      lbl.appendChild(b);
      box.appendChild(lbl);
    });
  }

  function getSelectedORsForCalc(){
    const arr = S.orCalcSelected || [];
    if(!arr.length) return OR_LIST.slice();
    return arr.slice();
  }

  // ‚úÖ NUEVO: inferir duraci√≥n del bloque NO estructural desde la fila
  function inferEventHoursInRow_(row, startIdx){
    const id = row.cells[startIdx]?.eventId;
    if(!id) return 1;
    let n = 0;
    for(let i = startIdx; i < row.cells.length; i++){
      if(row.cells[i]?.eventId === id) n++;
      else break;
    }
    return Math.max(1, n);
  }

  function go(viewId){
    ["viewReserve","viewMine","viewGrid","viewStruct","viewWait","viewReport","viewGroups"].forEach(id=>{
      const el = $(id);
      if(el){
        if(id === viewId) el.classList.remove("hide");
        else el.classList.add("hide");
      }
    });

    ["btnGoReserve","btnGoMine","btnGoGrid","btnGoStruct","btnGoWait","btnGoReport","btnGoGroups","btnGoAddGroup"].forEach(id=>{
      const btn = $(id);
      if(!btn) return;
      const target = id.replace("btnGo","view");
      if(target === viewId) btn.classList.add("active");
      else btn.classList.remove("active");
    });
  }

  function updateLoginUI(){
    const initial = $("loginInitial");
    const nameEl = $("loginName");
    if(!S.pin){
      if(initial) initial.textContent = "?";
      if(nameEl) nameEl.textContent = "Sin sesi√≥n";
      return;
    }
    if(initial) initial.textContent = "U";
    if(nameEl) nameEl.textContent = S.role === "master" ? "MASTER CEX" : "Usuario CEX";
  }

  function doLogin(){
    const pin = ( $("pin").value || "" ).trim();
    if(!pin){
      return showMsg($("msgLogin"), "Introduce tu pin personal.", "warn");
    }
    hideMsg($("msgLogin"));
    S.pin = pin;
    S.sessionKey = "";
    S.role = "user";
    sessionToken = String(Math.random()).slice(2) + String(Date.now());
    resetAllBusyUI();
    updateLoginUI();

    callGAS("loginCEX", [pin], {
      key:"login",
      msg:"Validando pin‚Ä¶",
      disable:[$("btnLogin"),$("pin")],
      onSuccess:(res)=>{
        if(!res || !res.ok){
          S.pin = "";
          S.role = "user";
          updateLoginUI();
          return showMsg($("msgLogin"), res && res.error ? res.error : "Pin no v√°lido.", "bad");
        }
        S.sessionKey = res.sessionKey || "";
        S.role = res.role || "user";
        updateLoginUI();
        showMsg($("msgLogin"), "Sesi√≥n iniciada correctamente.", "ok");

        if(S.role === "master"){
          $("btnGoGrid").classList.remove("hide");
          $("btnGoStruct").classList.remove("hide");
          $("btnGoWait").classList.remove("hide");
          $("btnGoReport").classList.remove("hide");
          $("btnGoGroups").classList.remove("hide");
          $("btnGoAddGroup").classList.remove("hide");
        }else{
          $("btnGoGrid").classList.add("hide");
          $("btnGoStruct").classList.add("hide");
          $("btnGoWait").classList.add("hide");
          $("btnGoReport").classList.add("hide");
          $("btnGoGroups").classList.add("hide");
          $("btnGoAddGroup").classList.add("hide");
        }

        go("viewReserve");
      },
      onFailure:(e)=>{
        S.pin = "";
        S.role = "user";
        updateLoginUI();
        showMsg($("msgLogin"), e && e.message ? e.message : "No se pudo validar el pin.", "bad");
      }
    });
  }

  function doLogout(){
    S.pin = "";
    S.sessionKey = "";
    S.role = "user";
    sessionToken = String(Math.random()).slice(2) + String(Date.now());
    resetAllBusyUI();
    updateLoginUI();
    ["msgLogin","msgReserve","msgMine","msgGrid","msgStructNon","msgStructEdit","msgWait","msgReport","msgGroups"].forEach(id=>{
      const el = $(id);
      if(el) hideMsg(el);
    });
    go("viewReserve");
  }

  // ===== RESERVA USUARIO =====
  function checkSlots(){
    hideMsg($("msgReserve"));
    const dateStr = $("rvDate").value || "";
    const hours = parseInt($("rvHours").value || "1", 10) || 1;
    if(!dateStr){
      return showMsg($("msgReserve"), "Selecciona una fecha.", "warn");
    }
    callGAS("checkSlotsCEX", [S.pin, dateStr, hours], {
      key:"checkSlots",
      msg:"Buscando huecos‚Ä¶",
      disable:[$("btnCheckSlots")],
      onSuccess:(res)=>{
        const slots = (res && res.slots) || [];
        renderReserveSlots(slots, hours);
        const canWait = !!(res && res.canWaitlist);
        const btnWait = $("btnOpenWaitlistFromReserve");
        if(btnWait){
          btnWait.classList.toggle("hide", !canWait);
        }
      },
      onFailure:(e)=>{
        showMsg($("msgReserve"), e && e.message ? e.message : "No se pudo obtener la disponibilidad.", "bad");
      }
    });
  }

  function renderReserveSlots(slots, hours){
    const box = $("slotsBox");
    box.innerHTML = "";
    if(!slots || !slots.length){
      box.innerHTML = '<div class="hint">No hay huecos para la fecha y duraci√≥n seleccionadas.</div>';
      return;
    }
    slots.forEach((s,idx)=>{
      const div = document.createElement("div");
      div.className = "slotsItem";
      div.dataset.idx = String(idx);
      const main = document.createElement("div");
      main.className = "slotsMain";
      const title = document.createElement("div");
      title.className = "slotsTitle";
      title.textContent = s.orName + " ¬∑ " + s.start + "‚Äì" + s.end;
      const meta = document.createElement("div");
      meta.className = "slotsMeta";
      meta.textContent = "Duraci√≥n: " + hours + " h";
      main.appendChild(title);
      main.appendChild(meta);
      div.appendChild(main);

      div.onclick = ()=>reserveSlot(s, hours);
      box.appendChild(div);
    });
  }

  function reserveSlot(slot, hours){
    hideMsg($("msgReserve"));
    const ok = confirm("¬øConfirmar reserva en " + slot.orName + " (" + slot.start + "‚Äì" + slot.end + ")?");
    if(!ok) return;

    callGAS("reserveSlotCEX", [S.pin, slot.orName, slot.startISO, hours], {
      key:"reserveSlot",
      msg:"Creando reserva‚Ä¶",
      onSuccess:(res)=>{
        showMsg($("msgReserve"), res && res.message ? res.message : "Reserva creada correctamente.", "ok");
        checkSlots();
      },
      onFailure:(e)=>{
        showMsg($("msgReserve"), e && e.message ? e.message : "No se pudo crear la reserva.", "bad");
      }
    });
  }

  function openWaitlistFromReserve(){
    const dateStr = $("rvDate").value || "";
    const hours = parseInt($("rvHours").value || "1",10) || 1;
    if(!dateStr){
      return showMsg($("msgReserve"), "Selecciona una fecha antes de abrir la lista de espera.", "warn");
    }
    const payload = {
      dateStr,
      hours
    };
    const data = encodeURIComponent(JSON.stringify(payload));
    const url = "https://script.google.com/macros/s/AKfycbxCEX_WAITLIST_FORM/exec?data=" + data;
    window.open(url, "_blank");
  }

  // ===== MIS CEXS =====
  function loadMine(){
    hideMsg($("msgMine"));
    const start = $("mineStart").value || "";
    const end   = $("mineEnd").value || "";
    callGAS("listMineCEX", [S.pin, start, end], {
      key:"mine",
      msg:"Cargando tus CEXs‚Ä¶",
      onSuccess:(res)=>{
        const list = (res && res.items) || [];
        renderMine(list);
      },
      onFailure:(e)=>{
        showMsg($("msgMine"), e && e.message ? e.message : "No se pudo cargar tu programaci√≥n.", "bad");
      }
    });
  }

  function renderMine(list){
    const box = $("mineList");
    box.innerHTML = "";
    if(!list || !list.length){
      box.innerHTML = '<div class="hint" style="padding:8px 10px;">No hay CEXs en el rango seleccionado.</div>';
      return;
    }
    let html = '<table><thead><tr><th>Fecha</th><th>CEX</th><th>Hora</th><th>Duraci√≥n</th><th>Etiqueta</th></tr></thead><tbody>';
    list.forEach(it=>{
      html += "<tr>" +
        "<td>" + escapeHtml(it.fecha || "") + "</td>" +
        "<td>" + escapeHtml(it.orName || "") + "</td>" +
        "<td>" + escapeHtml(it.hora || "") + "</td>" +
        "<td>" + escapeHtml(String(it.hours || "")) + " h</td>" +
        "<td>" + escapeHtml(it.label || "") + "</td>" +
      "</tr>";
    });
    html += "</tbody></table>";
    box.innerHTML = html;
  }

  // ===== GRID MASTER =====
  function loadGrid(){
    hideMsg($("msgGrid"));
    const dateStr = $("gdDate").value || "";
    if(!dateStr){
      return showMsg($("msgGrid"), "Selecciona una fecha.", "warn");
    }
    const hours = parseInt($("gdHours").value || "1",10) || 1;
    const orNames = getSelectedORsForCalc();
    callGAS("getGridCEX", [S.pin, dateStr, hours, orNames], {
      key:"grid",
      msg:"Cargando calendario‚Ä¶",
      disable:[$("btnLoadGrid")],
      onSuccess:(res)=>{
        renderGrid(res);
      },
      onFailure:(e)=>{
        showMsg($("msgGrid"), e && e.message ? e.message : "No se pudo cargar el calendario.", "bad");
      }
    });
  }

  function moveGridDay(delta){
    const el = $("gdDate");
    if(!el.value) return;
    const d = new Date(el.value);
    if(!isFinite(d)) return;
    d.setDate(d.getDate() + delta);
    el.valueAsDate = d;
    loadGrid();
  }

  function moveReserveDay(delta){
    const el = $("rvDate");
    if(!el.value) return;
    const d = new Date(el.value);
    if(!isFinite(d)) return;
    d.setDate(d.getDate() + delta);
    el.valueAsDate = d;
    checkSlots();
  }

  function renderGrid(res){
    const box = $("gridBox");
    box.innerHTML = "";
    if(!res || !res.grid || !res.grid.length){
      box.innerHTML = '<div class="hint" style="padding:8px 10px;">No hay programaci√≥n para la fecha seleccionada.</div>';
      $("gridKpis").innerHTML = "";
      return;
    }

    const data = res.grid;
    S.orList = res.orList || OR_LIST.slice();

    let html = '<table><thead><tr><th>CEX</th>';
    for(let h = res.startHour; h < res.endHour; h++){
      html += "<th>" + String(h).padStart(2,"0") + ":00</th>";
    }
    html += "</tr></thead><tbody>";

    data.forEach(row=>{
      html += "<tr>";
      html += "<td>" + escapeHtml(row.orName || "") + "</td>";
      row.slots.forEach(cell=>{
        const cls = [];
        let txt = "";
        if(cell.type === "E"){
          cls.push("cellE");
          txt = "E " + (cell.label || "");
        }else if(cell.type === "NE"){
          cls.push("cellNE");
          txt = "NE " + (cell.label || "");
        }else{
          txt = "";
        }
        html += "<td>" + escapeHtml(txt) + "</td>";
      });
      html += "</tr>";
    });

    html += "</tbody></table>";
    box.innerHTML = html;

    renderGridKpis(res.kpis || {});
  }

  function renderGridKpis(kpis){
    const box = $("gridKpis");
    box.innerHTML = "";
    if(!kpis) return;

    const items = [];

    if(kpis.totalHours != null){
      items.push({
        label:"Horas totales",
        value:(kpis.totalHours || 0) + " h",
        hint:"Todas las CEXs seleccionadas en KPIs."
      });
    }
    if(kpis.structHours != null){
      items.push({
        label:"Horas estructurales",
        value:(kpis.structHours || 0) + " h",
        hint:"CEXs estructurales de los equipos."
      });
    }
    if(kpis.nonStructHours != null){
      items.push({
        label:"Horas no estructurales",
        value:(kpis.nonStructHours || 0) + " h",
        hint:"CEXs a√±adidas como excepciones."
      });
    }

    if(!items.length) return;
    items.forEach(it=>{
      const div = document.createElement("div");
      div.className = "kpiItem";
      const v = document.createElement("b");
      v.textContent = it.value;
      const l = document.createElement("div");
      l.textContent = it.label;
      const h = document.createElement("div");
      h.textContent = it.hint || "";
      h.style.fontSize = "11px";
      h.style.color = "#6b7280";
      div.appendChild(v);
      div.appendChild(l);
      div.appendChild(h);
      box.appendChild(div);
    });
  }

  // ===== NO ESTRUCTURALES DESDE MASTER (b√∫squeda de huecos) =====
  function buildDoctorSelectForMaster(){
    const sel = $("stNSDoctorSelect");
    if(!sel) return;
    const searchBox = $("stNSDoctorSearch");
    const term = (searchBox && searchBox.value ? searchBox.value : "").trim().toLowerCase();

    sel.innerHTML = "";

    const list = S.doctorList || [];
    list.forEach(d=>{
      const email = d.correo || d.email || d.emailVisible || "";
      if(!email) return;
      const name = [d.nombre, d.apellidos].filter(Boolean).join(" ");
      const label = name ? (name + " ‚Äì " + email) : email;
      const haystack = (name + " " + email).toLowerCase();
      if(term && haystack.indexOf(term) === -1) return;

      const opt = document.createElement("option");
      opt.value = email;
      opt.textContent = label;
      sel.appendChild(opt);
    });

    if(!sel.options.length){
      const opt = document.createElement("option");
      opt.value = "";
      opt.textContent = term ? ("Sin resultados para \"" + term + "\"") : "(No hay profesionales disponibles)";
      opt.disabled = true;
      sel.appendChild(opt);
    }

    if(sel.options.length === 1 && sel.options[0].value){
      sel.selectedIndex = 0;
      const email = sel.value;
      if($("stNSDoctorEmail")) $("stNSDoctorEmail").value = email;
    }
  }

  function loadDoctorOptionsMaster(){
    if(S.doctorListLoaded) return;
    callGAS("listDoctorsForMaster", [S.pin], {
      key:"listDoctorsMaster",
      msg:"Cargando profesionales‚Ä¶",
      onSuccess:(res)=>{
        S.doctorList = res.doctors || res.lista || [];
        S.doctorListLoaded = true;
        buildDoctorSelectForMaster();
      },
      onFailure:(_)=>{
        S.doctorListLoaded = true;
      }
    });
  }

  // Calcula bloques libres
  function computeFreeBlocksForDateGrid(grid, hours){
    const results = [];
    if(!grid || !grid.length) return results;
    grid.forEach(row=>{
      const orName = row.orName;
      const cells = row.slots || [];
      const taken = cells.map(c=> !!c.type);
      const maxIdx = taken.length - 1;
      for(let i=0;i<taken.length;i++){
        if(taken[i]) continue;
        let run = 0;
        for(let j=i;j<taken.length && !taken[j];j++){
          run++;
        }
        if(run >= hours){
          const startHour = row.startHour + i;
          const endHour   = startHour + hours;
          results.push({
            orName,
            startHour,
            endHour,
            hours
          });
        }
      }
    });
    return results;
  }

  function masterFindNonStructSlots(opts){
    hideMsg($("msgStructNon"));
    const o = opts || {};
    const dateStr = o.dateStr || $("stNSDate").value || "";
    const hours = o.hours || parseInt($("stNSDur").value || "1",10) || 1;
    if(!dateStr){
      return showMsg($("msgStructNon"), "Selecciona una fecha.", "warn");
    }
    callGAS("getGridCEX", [S.pin, dateStr, hours, getSelectedORsForCalc()], {
      key:"masterNS",
      msg:"Buscando huecos no estructurales‚Ä¶",
      disable:[$("btnNSFindSlots")],
      onSuccess:(res)=>{
        const grid = res.grid || [];
        const slots = computeFreeBlocksForDateGrid(grid, hours);
        S.masterNSSlots = slots;
        S.masterNSSelectedIndex = -1;
        S.masterNSQuery = { dateStr, hours };
        renderMasterNSSlots(slots, dateStr, hours, !!o.afterCreate);
      },
      onFailure:(e)=>{
        showMsg($("msgStructNon"), e && e.message ? e.message : "No se pudo obtener la disponibilidad.", "bad");
      }
    });
  }

  function renderMasterNSSlots(slots, dateStr, hours, afterCreate){
    const box = $("stNSSlotsBox");
    box.innerHTML = "";
    if(!slots || !slots.length){
      const txt = afterCreate
        ? "CEX no estructural creado. No hay m√°s huecos disponibles con los filtros actuales."
        : "No hay huecos disponibles para la fecha y duraci√≥n seleccionadas.";
      box.innerHTML = '<div class="hint">' + escapeHtml(txt) + '</div>';
      return;
    }

    slots.forEach((s,idx)=>{
      const div = document.createElement("div");
      div.className = "slotsItem";
      div.dataset.idx = String(idx);
      const main = document.createElement("div");
      main.className = "slotsMain";
      const title = document.createElement("div");
      title.className = "slotsTitle";
      title.textContent = s.orName + " ¬∑ " +
        String(s.startHour).padStart(2,"0") + ":00‚Äì" +
        String(s.endHour).padStart(2,"0") + ":00";
      const meta = document.createElement("div");
      meta.className = "slotsMeta";
      meta.textContent = "Fecha " + dateStr + " ¬∑ " + hours + " h";
      main.appendChild(title);
      main.appendChild(meta);
      div.appendChild(main);

      div.onclick = ()=>{
        S.masterNSSelectedIndex = idx;
        Array.from(box.children).forEach(ch=>{
          ch.classList.remove("selected");
        });
        div.classList.add("selected");
      };

      box.appendChild(div);
    });
  }

  function masterAssignNonStructSlot(){
    hideMsg($("msgStructNon"));
    const idx = S.masterNSSelectedIndex;
    if(idx < 0 || !S.masterNSSlots.length){
      return showMsg($("msgStructNon"), "Primero selecciona uno de los huecos disponibles.", "warn");
    }

    const slot = S.masterNSSlots[idx];
    const dateStr = S.masterNSQuery?.dateStr || slot.date;
    const hours = S.masterNSQuery?.hours || slot.hours;
    const orName = slot.orName;

    const email = ($("stNSDoctorEmail").value || "").trim();
    if(!email){
      return showMsg($("msgStructNon"), "Selecciona o escribe el email del usuario.", "warn");
    }

    const rawLabel = ($("stNSLabel").value || "").trim();
    const label = rawLabel || email;

    const ok = confirm(
      "¬øConfirmar CEX NO estructural?\n\n" +
      "CEX: " + orName + "\n" +
      "Fecha: " + dateStr + "\n" +
      "Hora: " + String(slot.startHour).padStart(2,"0") + ":00‚Äì" +
      String(slot.endHour).padStart(2,"0") + ":00\n" +
      "Duraci√≥n: " + hours + " h\n" +
      "Usuario: " + email + "\n" +
      "Etiqueta: " + label
    );
    if(!ok) return;

    callGAS("masterCreateNonStructural", [{
      pin: S.pin,
      dateStr,
      hour: slot.startHour,
      hours,
      orName,
      email,
      label
    }], {
      key:"masterAssignNS",
      msg:"Creando CEX no estructural‚Ä¶",
      disable:[$("btnNSAssignSlot")],
      onSuccess:(res)=>{
        showMsg($("msgStructNon"), res?.message || "CEX no estructural creado.", "ok");
        masterFindNonStructSlots({ refreshOnly:true, afterCreate:true, dateStr, hours });

        const gdDate = $("gdDate").value;
        if(gdDate && gdDate === dateStr){
          loadGrid();
        }
      },
      onFailure:(e)=>{
        showMsg($("msgStructNon"), e?.message || String(e), "bad");
      }
    });
  }

  // ===== ESTRUCTURAL EDITOR =====
  function clearStructEditor(){
    $("stId").value = "";
    $("stLabel").value = "";
    $("stOr").value = "";
    $("stStartHour").value = "";
    $("stHours").value = "4";
    $("stCadence").value = "WEEKLY";
    $("stFrom").value = "";
    $("stTo").value = "";
    document.querySelectorAll(".stDow").forEach(cb=>cb.checked=false);
    document.querySelectorAll(".stWom").forEach(cb=>cb.checked=false);
    $("boxMonthWeeks").classList.add("hide");
  }

  function loadStructLists(){
    callGAS("listStructCEX", [S.pin], {
      key:"structLists",
      msg:"Cargando programaci√≥n estructural‚Ä¶",
      onSuccess:(res)=>{
        S.structData = res.list || [];
        const labels = res.labels || [];
        const ors = res.ors || OR_LIST.slice();
        const hoursList = res.hours || [8,6,4];
        const hourOpts = hoursList.map(h=>String(h));
        renderStructEditorCombos(labels, ors, hourOpts);
        renderStructList(S.structData);
      },
      onFailure:(e)=>{
        showMsg($("msgStructEdit"), e && e.message ? e.message : "No se pudo cargar la programaci√≥n estructural.", "bad");
      }
    });
  }

  function renderStructEditorCombos(labels, ors, hourOpts){
    const selLabel = $("stLabel");
    const selOr = $("stOr");
    const selHour = $("stStartHour");
    const selDur = $("stHours");
    if(selLabel){
      selLabel.innerHTML = "";
      labels.forEach(l=>{
        const opt = document.createElement("option");
        opt.value = l;
        opt.textContent = l;
        selLabel.appendChild(opt);
      });
    }
    if(selOr){
      selOr.innerHTML = "";
      ors.forEach(o=>{
        const opt = document.createElement("option");
        opt.value = o;
        opt.textContent = o;
        selOr.appendChild(opt);
      });
    }
    if(selHour){
      selHour.innerHTML = "";
      for(let h=8; h<=20; h++){
        const opt = document.createElement("option");
        opt.value = String(h);
        opt.textContent = String(h).padStart(2,"0") + ":00";
        selHour.appendChild(opt);
      }
    }
    if(selDur){
      selDur.innerHTML = "";
      hourOpts.forEach(h=>{
        const opt = document.createElement("option");
        opt.value = h;
        opt.textContent = h + " h";
        selDur.appendChild(opt);
      });
    }
  }

  function saveStructFromEditor(){
    hideMsg($("msgStructEdit"));
    const id = ($("stId").value || "").trim();
    const label = ($("stLabel").value || "").trim();
    const orName = $("stOr").value || "";
    const startHour = parseInt($("stStartHour").value || "8",10) || 8;
    const hours = parseInt($("stHours").value || "4",10) || 4;
    const cadence = $("stCadence").value || "WEEKLY";
    const from = $("stFrom").value || "";
    const to = $("stTo").value || "";
    const dows = Array.from(document.querySelectorAll(".stDow"))
      .filter(cb=>cb.checked)
      .map(cb=>parseInt(cb.value,10));
    const woms = Array.from(document.querySelectorAll(".stWom"))
      .filter(cb=>cb.checked)
      .map(cb=>parseInt(cb.value,10));

    if(!label || !orName || !from || !to || !dows.length){
      return showMsg($("msgStructEdit"), "Rellena etiqueta, CEX, rango de fechas y al menos un d√≠a de la semana.", "warn");
    }
    if(cadence === "MONTH_WEEKS" && !woms.length){
      return showMsg($("msgStructEdit"), "Selecciona al menos una semana del mes para la cadencia de semanas.", "warn");
    }

    const payload = {
      id: id || null,
      label,
      orName,
      startHour,
      hours,
      cadence,
      from,
      to,
      dows,
      woms
    };

    callGAS("saveStructCEX", [S.pin, payload], {
      key:"saveStruct",
      msg:"Guardando programaci√≥n estructural‚Ä¶",
      disable:[$("btnSaveStruct")],
      onSuccess:(res)=>{
        showMsg($("msgStructEdit"), res && res.message ? res.message : "Programaci√≥n estructural guardada.", "ok");
        loadStructLists();
      },
      onFailure:(e)=>{
        showMsg($("msgStructEdit"), e && e.message ? e.message : "No se pudo guardar la programaci√≥n estructural.", "bad");
      }
    });
  }

  function deleteStructById(){
    hideMsg($("msgStructEdit"));
    const id = ($("stId").value || "").trim();
    if(!id) return showMsg($("msgStructEdit"), "Indica un ID para eliminar.", "warn");
    const ok = confirm("¬øEliminar la programaci√≥n estructural con ID " + id + "?");
    if(!ok) return;
    callGAS("deleteStructCEX", [S.pin, id], {
      key:"delStruct",
      msg:"Eliminando programaci√≥n estructural‚Ä¶",
      disable:[$("btnDeleteStructById")],
      onSuccess:(res)=>{
        showMsg($("msgStructEdit"), res && res.message ? res.message : "Programaci√≥n estructural eliminada.", "ok");
        loadStructLists();
      },
      onFailure:(e)=>{
        showMsg($("msgStructEdit"), e && e.message ? e.message : "No se pudo eliminar la programaci√≥n estructural.", "bad");
      }
    });
  }

  function renderStructList(list){
    const box = $("structList");
    box.innerHTML = "";
    if(!list || !list.length){
      box.innerHTML = '<div class="hint" style="padding:8px 10px;">No hay reglas estructurales definidas.</div>';
      return;
    }

    const teamFilter = $("structTeamFilter").value || "";
    const orFilter = $("structOrFilter").value || "";
    const hourFilter = $("structHourFilter").value || "";

    let html = '<table><thead><tr>' +
      '<th>ID</th><th>Equipo</th><th>CEX</th><th>Inicio</th><th>Duraci√≥n</th><th>Cadencia</th><th>D√≠as</th><th>Semanas</th><th>Rango</th>' +
    '</tr></thead><tbody>';

    list.forEach(row=>{
      if(teamFilter && row.label !== teamFilter) return;
      if(orFilter && row.orName !== orFilter) return;
      if(hourFilter && String(row.startHour) !== hourFilter) return;

      html += "<tr data-id=\"" + escapeHtml(row.id || "") + "\">" +
        "<td>" + escapeHtml(row.id || "") + "</td>" +
        "<td>" + escapeHtml(row.label || "") + "</td>" +
        "<td>" + escapeHtml(row.orName || "") + "</td>" +
        "<td>" + String(row.startHour).padStart(2,"0") + ":00" + "</td>" +
        "<td>" + escapeHtml(String(row.hours || "")) + " h</td>" +
        "<td>" + escapeHtml(row.cadenceNameEs || row.cadence || "") + "</td>" +
        "<td>" + escapeHtml((row.dows || []).join(",") || "") + "</td>" +
        "<td>" + escapeHtml((row.woms || []).join(",") || "") + "</td>" +
        "<td>" + escapeHtml((row.from || "") + " ‚Äì " + (row.to || "")) + "</td>" +
      "</tr>";
    });

    html += "</tbody></table>";
    box.innerHTML = html;

    box.querySelectorAll("tbody tr").forEach(tr=>{
      tr.onclick = ()=>{
        const id = tr.getAttribute("data-id") || "";
        const found = S.structData.find(r=>String(r.id) === id);
        if(!found) return;
        fillStructEditorFromRow(found);
      };
    });

    const teams = new Set();
    const ors = new Set();
    const hours = new Set();
    list.forEach(r=>{
      if(r.label) teams.add(r.label);
      if(r.orName) ors.add(r.orName);
      if(r.startHour != null) hours.add(String(r.startHour));
    });

    const teamSel = $("structTeamFilter");
    const orSel = $("structOrFilter");
    const hourSel = $("structHourFilter");

    if(teamSel && teamSel.options.length <= 1){
      teams.forEach(t=>{
        const opt = document.createElement("option");
        opt.value = t;
        opt.textContent = t;
        teamSel.appendChild(opt);
      });
    }
    if(orSel && orSel.options.length <= 1){
      ors.forEach(o=>{
        const opt = document.createElement("option");
        opt.value = o;
        opt.textContent = o;
        orSel.appendChild(opt);
      });
    }
    if(hourSel && hourSel.options.length <= 1){
      Array.from(hours).sort((a,b)=>parseInt(a,10)-parseInt(b,10)).forEach(h=>{
        const opt = document.createElement("option");
        opt.value = h;
        opt.textContent = h.padStart(2,"0") + ":00";
        hourSel.appendChild(opt);
      });
    }
  }

  function fillStructEditorFromRow(row){
    $("stId").value = row.id || "";
    $("stLabel").value = row.label || "";
    $("stOr").value = row.orName || "";
    $("stStartHour").value = String(row.startHour || 8);
    $("stHours").value = String(row.hours || 4);
    $("stCadence").value = row.cadence || "WEEKLY";
    $("stFrom").value = row.from || "";
    $("stTo").value = row.to || "";

    const dows = new Set(row.dows || []);
    document.querySelectorAll(".stDow").forEach(cb=>{
      cb.checked = dows.has(parseInt(cb.value,10));
    });

    const woms = new Set(row.woms || []);
    document.querySelectorAll(".stWom").forEach(cb=>{
      cb.checked = woms.has(parseInt(cb.value,10));
    });

    if((row.cadence || "WEEKLY") === "MONTH_WEEKS"){
      $("boxMonthWeeks").classList.remove("hide");
    }else{
      $("boxMonthWeeks").classList.add("hide");
    }
  }

  // ===== WAITLIST MASTER =====
  function openWaitlist(){
    go("viewWait");
    loadWaitlistMaster();
  }

  function loadWaitlistMaster(){
    hideMsg($("msgWait"));
    const filter = $("wlFilter").value || "all";
    callGAS("listWaitlist", [S.pin, filter], {
      key:"waitlist",
      msg:"Cargando lista de espera‚Ä¶",
      disable:[$("btnLoadWait")],
      onSuccess:(res)=>{
        const items = (res && res.items) || [];
        renderWaitlist(items);
      },
      onFailure:(e)=>{
        showMsg($("msgWait"), e && e.message ? e.message : "No se pudo cargar la lista de espera.", "bad");
      }
    });
  }

  function renderWaitlist(items){
    const box = $("waitList");
    box.innerHTML = "";
    if(!items || !items.length){
      box.innerHTML = '<div class="hint" style="padding:8px 10px;">No hay solicitudes en la lista de espera.</div>';
      return;
    }
    let html = '<table><thead><tr>' +
      '<th>ID</th><th>Fecha solicitud</th><th>Paciente</th><th>Profesional</th><th>Motivo</th><th>Deseos</th><th>Estado</th>' +
    '</tr></thead><tbody>';
    items.forEach(it=>{
      html += "<tr>" +
        "<td>" + escapeHtml(String(it.id || "")) + "</td>" +
        "<td>" + escapeHtml(it.fechaSolicitud || "") + "</td>" +
        "<td>" + escapeHtml(it.paciente || "") + "</td>" +
        "<td>" + escapeHtml(it.profesional || "") + "</td>" +
        "<td>" + escapeHtml(it.motivo || "") + "</td>" +
        "<td>" + escapeHtml(it.deseos || "") + "</td>" +
        "<td>" + escapeHtml(it.estado || "") + "</td>" +
      "</tr>";
    });
    html += "</tbody></table>";
    box.innerHTML = html;
  }

  // ===== REPORTES =====
  function sendReport(){
    hideMsg($("msgReport"));
    const email = ($("rpEmail").value || "").trim();
    const start = $("rpStart").value || "";
    const end   = $("rpEnd").value || "";
    if(!email || !start || !end){
      return showMsg($("msgReport"), "Rellena email, inicio y fin.", "warn");
    }
    callGAS("sendCEXReport", [S.pin, email, start, end], {
      key:"report",
      msg:"Generando y enviando reporte‚Ä¶",
      disable:[$("btnSendReport")],
      onSuccess:(res)=>{
        showMsg($("msgReport"), res && res.message ? res.message : "Reporte enviado correctamente.", "ok");
      },
      onFailure:(e)=>{
        showMsg($("msgReport"), e && e.message ? e.message : "No se pudo enviar el reporte.", "bad");
      }
    });
  }

  function generateStructVisualReport(){
    hideMsg($("msgReport"));
    callGAS("getStructuralProgramReport", [S.pin], {
      key:"structVisual",
      msg:"Generando reporte estructural visual‚Ä¶",
      disable:[$("btnStructVisualReport")],
      onSuccess:(res)=>{
        S.structVisual = res || {};
        renderStructVisualReport();
      },
      onFailure:(e)=>{
        showMsg($("msgReport"), e && e.message ? e.message : "No se pudo generar el reporte estructural.", "bad");
      }
    });
  }

  function renderStructVisualReport(){
    const box = $("structVisualReport");
    if(!S.structVisual){
      box.classList.add("hide");
      box.innerHTML = "";
      return;
    }

    const data = S.structVisual;
    const rows = data.rows || [];
    if(!rows.length){
      box.classList.add("hide");
      box.innerHTML = '<div class="hint" style="padding:8px 10px;">No hay datos estructurales.</div>';
      return;
    }

    let html = '<table><thead><tr><th>D√≠a</th><th>Sesi√≥n</th><th>CEX</th><th>Equipo</th><th>Horas/mes</th></tr></thead><tbody>';
    rows.forEach(r=>{
      html += "<tr>" +
        "<td>" + escapeHtml(r.dayName || "") + "</td>" +
        "<td>" + escapeHtml(r.session || "") + "</td>" +
        "<td>" + escapeHtml(r.orName || "") + "</td>" +
        "<td>" + escapeHtml(r.label || "") + "</td>" +
        "<td>" + escapeHtml(String(r.hours || "")) + "</td>" +
      "</tr>";
    });
    html += "</tbody></table>";
    box.innerHTML = html;
    box.classList.remove("hide");
  }

  // ===== EQUIPOS (GRUPOS) =====
  function openGroupsView(){
    loadGroups();
  }

  function loadGroups(){
    hideMsg($("msgGroups"));
    callGAS("listGroupsQuirurgicos", [S.pin], {
      key:"groups",
      msg:"Cargando equipos m√©dicos‚Ä¶",
      disable:[$("btnGroupsReload")],
      onSuccess:(res)=>{
        S.groups = res.items || res.grupos || [];
        renderGroups();
      },
      onFailure:(e)=>{
        showMsg($("msgGroups"), e && e.message ? e.message : "No se pudo cargar el listado de equipos.", "bad");
      }
    });
  }

  function renderGroups(){
    const box = $("groupsList");
    const search = ( $("groupsSearch").value || "" ).trim().toLowerCase();
    const specFilter = $("groupsSpecFilter").value || "";

    let specs = new Set();

    const items = S.groups.filter(g=>{
      const name = (g.Cirujano || g.nombre || "").toLowerCase();
      const esp  = (g.Especialidad || g.especialidad || "").toLowerCase();
      const email = (g.Email || g.correo || g.email || "").toLowerCase();
      if(esp) specs.add(esp);
      if(specFilter && esp !== specFilter.toLowerCase()) return false;
      if(!search) return true;
      const haystack = name + " " + esp + " " + email;
      return haystack.indexOf(search) !== -1;
    });

    const specSel = $("groupsSpecFilter");
    if(specSel && specSel.options.length <= 1){
      Array.from(specs).sort().forEach(s=>{
        const opt = document.createElement("option");
        opt.value = s;
        opt.textContent = s.toUpperCase();
        specSel.appendChild(opt);
      });
    }

    if(!items.length){
      box.innerHTML = '<div class="hint" style="padding:8px 10px;">No hay equipos que coincidan con el filtro.</div>';
      return;
    }

    let html = "";
    items.forEach(g=>{
      const name = g.Cirujano || g.nombre || "";
      const esp = g.Especialidad || g.especialidad || "";
      const email = g.Email || g.correo || g.email || "";
      const tel = g.Telefono || g.telefono || "";
      const rol = g.Rol || g.rol || "";

      html += '<div class="grpRow">' +
        '<div class="grpName">' + escapeHtml(name) + '</div>' +
        '<div class="grpSpec">' + escapeHtml(esp) + '</div>' +
        '<div class="grpMeta">' +
          (email ? '<span class="tag">üìß ' + escapeHtml(email) + '</span>' : '') +
          (tel ? '<span class="tag">üìû ' + escapeHtml(tel) + '</span>' : '') +
          (rol ? '<span class="tag">üë§ ' + escapeHtml(rol) + '</span>' : '') +
        '</div>' +
      '</div>';
    });
    box.innerHTML = html;
  }

  function openAddGroupModal(){
    alert("Alta de grupos: por ahora gestionar directamente en la hoja GruposQuir√∫rgicos.");
  }

  // --- Solicitud de cambio: modal + env√≠o directo (Apps Script) ---
  let __swapTeam = "";
  let __swapContext = null;

  function openSwapModal(team, context){
    __swapTeam = String(team||"").trim();
    __swapContext = context || null;
    const overlay = $("swapModalOverlay");
    const content = $("swapModalContent");
    const status = $("swapStatus");
    if(!overlay || !content || !status) return;

    const match = String(team||"").trim();
    content.innerHTML = `
    <div class="dlgGrid">
      <div class="dlgK">Equipo</div><div class="dlgV">${escapeHtml(match)}</div>
      <div class="dlgK">Contexto</div><div class="dlgV">${escapeHtml((context && context.info) || "CEX estructural")}</div>
    </div>
    `;
    status.textContent = "";
    overlay.style.display = "flex";
  }

  function closeModal(){
    const overlay = $("swapModalOverlay");
    if(overlay) overlay.style.display = "none";
  }

  function applyModalChanges(){
    const status = $("swapStatus");
    const comment = $("swapComment").value || "";
    status.textContent = "Enviando solicitud‚Ä¶";

    (async ()=>{
      try{
        let to = "";
        let subject = "Solicitud de cambio de equipo CEX";
        let body = "";

        body += "Equipo actual: " + (__swapTeam || "") + "\\n";
        body += "Contexto: " + ((__swapContext && __swapContext.info) || "CEX estructural") + "\\n";
        body += "\\n";
        body += "Comentario adicional:\\n" + comment + "\\n";

        const mailto = "mailto:?subject=" + encodeURIComponent(subject) + "&body=" + encodeURIComponent(body);
        window.location.href = mailto;

        status.textContent = "Solicitud preparada en tu cliente de correo.";
        setTimeout(()=>{ $("swapModalOverlay").style.display = "none"; }, 800);
      }catch(err){
        console.error(err);
        status.textContent = "No se pudo preparar la solicitud.";
      }
    })();
  }

  document.addEventListener("DOMContentLoaded", ()=>{
    window.addEventListener("error", (ev)=>{
      try{
        const msg = (ev && ev.message) ? ("Error JS: " + ev.message) : "Error JS.";
        showMsg($("msgLogin"), msg, "bad");
      }catch(e){}
    });
    window.addEventListener("unhandledrejection", (ev)=>{
      try{
        const reason = ev && ev.reason ? (ev.reason.message || String(ev.reason)) : "Promise rechazada.";
        showMsg($("msgLogin"), "Error JS: " + reason, "bad");
      }catch(e){}
    });

    try{
      updateLoginUI();
      initOrCalcDefaults();
      buildOrCalcChips();

      const today = new Date();
      const isoToday = today.toISOString().slice(0,10);
      if($("rvDate")) $("rvDate").value = isoToday;
      if($("gdDate")) $("gdDate").value = isoToday;
      if($("mineStart")){
        const d = new Date(today);
        d.setMonth(d.getMonth()-1);
        $("mineStart").value = d.toISOString().slice(0,10);
      }
      if($("mineEnd")) $("mineEnd").value = isoToday;
      if($("rpStart")){
        const d2 = new Date(today);
        d2.setMonth(d2.getMonth()-1);
        $("rpStart").value = d2.toISOString().slice(0,10);
      }
      if($("rpEnd")) $("rpEnd").value = isoToday;

      go("viewReserve");

      if($("btnLogin")) $("btnLogin").onclick = doLogin;
      if($("btnLogout")) $("btnLogout").onclick = doLogout;

      if($("btnGoReserve")) $("btnGoReserve").onclick = ()=>go("viewReserve");
      if($("btnGoMine")) $("btnGoMine").onclick = ()=>go("viewMine");
      if($("btnGoGrid")) $("btnGoGrid").onclick = ()=>{ go("viewGrid"); };
      if($("btnGoStruct")) $("btnGoStruct").onclick  = ()=>{
        go("viewStruct");
        refreshStructList();
        loadDoctorOptionsMaster();
      };

      if($("btnGoWait")) $("btnGoWait").onclick    = openWaitlist;
      if($("btnGoReport")) $("btnGoReport").onclick  = ()=>go("viewReport");

      if($("btnGoGroups")) $("btnGoGroups").onclick = ()=>{ go("viewGroups"); openGroupsView(); };
      if($("btnGoAddGroup")) $("btnGoAddGroup").onclick = ()=>{ go("viewGroups"); openGroupsView(); openAddGroupModal(); };
      $("btnCheckSlots").onclick = checkSlots;
      if($("btnOpenWaitlistFromReserve")) $("btnOpenWaitlistFromReserve").onclick = openWaitlistFromReserve;
      if($("btnLoadMine")) $("btnLoadMine").onclick = loadMine;

      if($("btnLoadGrid")) $("btnLoadGrid").onclick = loadGrid;
      if($("btnToggleAdvanced")) $("btnToggleAdvanced").onclick = ()=>{
        $("advancedBox").classList.toggle("hide");
      };

      if($("btnGridPrevDay")) $("btnGridPrevDay").onclick = ()=>moveGridDay(-1);
      if($("btnGridNextDay")) $("btnGridNextDay").onclick = ()=>moveGridDay(1);
      if($("btnRvPrevDay"))   $("btnRvPrevDay").onclick   = ()=>moveReserveDay(-1);
      if($("btnRvNextDay"))   $("btnRvNextDay").onclick   = ()=>moveReserveDay(1);

      if($("btnNewStruct")) $("btnNewStruct").onclick = clearStructEditor;
      if($("btnSaveStruct")) $("btnSaveStruct").onclick = saveStructFromEditor;
      if($("btnDeleteStructById")) $("btnDeleteStructById").onclick = deleteStructById;
      if($("btnReloadStruct")) $("btnReloadStruct").onclick = loadStructLists;

      if($("stCadence")){
        $("stCadence").onchange = ()=>{
          if($("stCadence").value === "MONTH_WEEKS"){
            $("boxMonthWeeks").classList.remove("hide");
          }else{
            $("boxMonthWeeks").classList.add("hide");
          }
        };
      }

      if($("structTeamFilter")) $("structTeamFilter").onchange = ()=>renderStructList(S.structData || []);
      if($("structOrFilter")) $("structOrFilter").onchange = ()=>renderStructList(S.structData || []);
      if($("structHourFilter")) $("structHourFilter").onchange = ()=>renderStructList(S.structData || []);

      if($("btnNSFindSlots")) $("btnNSFindSlots").onclick = ()=>masterFindNonStructSlots();
      if($("btnNSAssignSlot")) $("btnNSAssignSlot").onclick = masterAssignNonStructSlot;

      const selDoctor = $("stNSDoctorSelect");
      if(selDoctor){
        selDoctor.onchange = ()=>{
          const email = selDoctor.value || "";
          $("stNSDoctorEmail").value = email;
        };
      }

      const searchDoctor = $("stNSDoctorSearch");
      if(searchDoctor){
        let searchTimeout = null;
        const applyFilter = ()=>{
          try{ buildDoctorSelectForMaster(); }catch(e){ console.error(e); }
        };
        searchDoctor.oninput = ()=>{
          if(searchTimeout) clearTimeout(searchTimeout);
          searchTimeout = setTimeout(applyFilter, 150);
        };
      }

      if($("btnLoadWait")) $("btnLoadWait").onclick = loadWaitlistMaster;
      $("wlFilter").onchange = ()=>{ if(!$("#viewWait").classList.contains("hide")) loadWaitlistMaster(); };

      if($("btnSendReport")) $("btnSendReport").onclick = sendReport;
      if($("btnStructVisualReport")) $("btnStructVisualReport").onclick = generateStructVisualReport;

      if($("btnModalClose")) $("btnModalClose").onclick = closeModal;
      if($("btnModalApply")) $("btnModalApply").onclick = applyModalChanges;
    }catch(e){
      try{ showMsg($("msgLogin"), "Error JS: " + (e && e.message ? e.message : String(e)), "bad"); }catch(_){}
      throw e;
    }
  });

  function refreshStructList(){
    loadStructLists();
  }
</script>

</body>
</html>
